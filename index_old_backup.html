<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<title>Super Agent ‚Äì AI Development Platform</title>
<script>
// Force cache clear on version mismatch
const CURRENT_VERSION = 'v5.1.0';
const storedVersion = localStorage.getItem('app_version');
if (storedVersion !== CURRENT_VERSION) {
  localStorage.setItem('app_version', CURRENT_VERSION);
  if (storedVersion !== null) {
    location.reload(true);
  }
}
</script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
<style>
/* ==== Base ==== */
*{margin:0;padding:0;box-sizing:border-box;}
body{
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
  background:#000;color:#D0D4E0;
  height:100vh;display:flex;justify-content:center;align-items:flex-start;padding:1rem;
  overflow-x:hidden;overflow-y:scroll;position:relative;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
}

/* Animated Particle Background - Purple Gradient Style */
#particles-canvas{
  position:fixed;top:0;left:0;width:100%;height:100%;
  z-index:0;pointer-events:none;
  background:radial-gradient(ellipse at center, #1a0a28 0%, #000 100%);
}
body::before{
  content:'';position:fixed;top:0;left:0;width:100%;height:100%;
  background:radial-gradient(circle at 50% 50%, rgba(147,51,234,0.03) 0%, transparent 50%);
  z-index:1;pointer-events:none;
}

/* ==== Layout ==== */
.container{max-width:600px;width:100%;display:flex;flex-direction:column;position:relative;z-index:10;padding-bottom:0.5rem;}

/* ==== Header (Purple gradient professional theme) ==== */
header{
  background:linear-gradient(135deg, rgba(35,15,42,0.8), rgba(59,30,70,0.8));
  backdrop-filter:blur(10px);
  color:#F4F6FB;padding:1.25rem 1rem 3rem 1rem;
  border-radius:0 0 1.5rem 1.5rem;text-align:center;position:relative;
  box-shadow:0 4px 20px rgba(0,0,0,.6),0 0 40px rgba(147,51,234,.1),inset 0 1px 0 rgba(147,51,234,.1);
  border:1px solid rgba(147,51,234,.2);
}
.workspace{
  position:absolute;top:1rem;left:1rem;
  background:rgba(192,199,212,.15);color:#C0C7D4;font-size:.75rem;
  padding:.3rem .65rem;border-radius:2rem;display:flex;align-items:center;gap:.35rem;
  border:1px solid rgba(192,199,212,.2);
}
.workspace::before{
  content:"SA";width:1.2rem;height:1.2rem;
  background:linear-gradient(135deg,#8A93A6,#C0C7D4);color:#0D0F13;
  border-radius:50%;font-weight:700;font-size:.65rem;line-height:1.2rem;text-align:center;
  box-shadow:0 2px 4px rgba(0,0,0,.3);
}
header h1{font-size:1.5rem;font-weight:700;margin-top:.4rem;letter-spacing:-0.02em;
  background:linear-gradient(135deg,#F4F6FB,#C0C7D4);-webkit-background-clip:text;
  -webkit-text-fill-color:transparent;background-clip:text;}
header p{font-size:.9rem;opacity:.9;margin-top:.4rem;font-weight:400;line-height:1.6;color:#A0A8B8;}

/* ==== Card ==== */
.card{
  flex:0;margin:1.5rem 0 0.5rem 0;
  background:linear-gradient(135deg, rgba(35,15,42,0.6), rgba(59,30,70,0.6));
  backdrop-filter:blur(10px);
  border-radius:1.5rem;
  box-shadow:0 12px 32px rgba(0,0,0,.6),0 0 40px rgba(147,51,234,.08),inset 0 1px 0 rgba(147,51,234,.08);
  padding:1.5rem 1.2rem;display:flex;flex-direction:column;gap:1.25rem;
  border:1px solid rgba(147,51,234,.2);
}
.greeting{
  text-align:center;font-size:1.15rem;color:#C0C7D4;line-height:1.5;
  font-weight:600;letter-spacing:-0.01em;
}

/* Textarea */
textarea{
  flex:1;resize:none;border:1.5px solid rgba(138,147,166,.3);border-radius:1rem;
  padding:1.1rem 1.25rem;font-size:1rem;background:#0D0F13;color:#F4F6FB;
  font-family:inherit;line-height:1.6;
  transition:border-color 0.2s ease,box-shadow 0.2s ease;
  box-shadow:inset 0 2px 4px rgba(0,0,0,.3);
}
textarea::placeholder{color:#5A5F6E;font-weight:400;}
textarea:focus{
  outline:none;border-color:#8A93A6;
  box-shadow:inset 0 2px 4px rgba(0,0,0,.3),0 0 0 3px rgba(138,147,166,.2);
}

/* Toolbar */
.toolbar{
  display:flex;align-items:center;gap:.6rem;color:#8A93A6;font-size:.75rem;
  flex-wrap:wrap;
}
.toolbar .icon{
  cursor:pointer;padding:.35rem;border-radius:.5rem;transition:all .2s;
  display:flex;align-items:center;justify-content:center;
  background:rgba(138,147,166,.1);border:1px solid rgba(138,147,166,.2);
}
.toolbar .icon:hover{background:rgba(138,147,166,.25);border-color:rgba(192,199,212,.3);}
.toolbar .icon.recording{
  background:#DC2626;color:#fff;animation:pulse-recording 1.5s infinite;
  border-color:#DC2626;
}
@keyframes pulse-recording{
  0%,100%{transform:scale(1);opacity:1;}
  50%{transform:scale(1.1);opacity:0.8;}
}

/* Plan Mode Toggle */
.mode-toggle{
  display:flex;align-items:center;gap:0.4rem;cursor:pointer;
  padding:0.35rem 0.6rem;border-radius:0.6rem;
  background:rgba(138,147,166,.1);border:1px solid rgba(138,147,166,.2);
  transition:all 0.2s;font-size:0.75rem;color:#8A93A6;
  white-space:nowrap;
}
.mode-toggle:hover{background:rgba(138,147,166,.2);}
.mode-toggle input[type="checkbox"]{
  appearance:none;width:2.2rem;height:1.1rem;background:rgba(138,147,166,.3);
  border-radius:1rem;position:relative;cursor:pointer;transition:all 0.3s;
  border:1px solid rgba(138,147,166,.4);flex-shrink:0;
}
.mode-toggle input[type="checkbox"]::before{
  content:'';position:absolute;width:0.8rem;height:0.8rem;border-radius:50%;
  background:#8A93A6;top:0.1rem;left:0.15rem;transition:all 0.3s;
  box-shadow:0 2px 4px rgba(0,0,0,.3);
}
.mode-toggle input[type="checkbox"]:checked{background:linear-gradient(135deg,#9333EA,#7C3AED);}
.mode-toggle input[type="checkbox"]:checked::before{
  left:1.2rem;background:#fff;
}
.mode-label{font-weight:600;}

/* Start button */
.start-btn{
  background:linear-gradient(135deg,#8A93A6,#C0C7D4);
  color:#0D0F13;border:1px solid rgba(192,199,212,.3);padding:.65rem 1.2rem;border-radius:.85rem;
  font-weight:700;font-size:.88rem;cursor:pointer;letter-spacing:-0.01em;
  display:flex;align-items:center;gap:.5rem;
  box-shadow:0 4px 14px rgba(0,0,0,.4),inset 0 1px 0 rgba(255,255,255,.2);
  transition:transform .15s ease,box-shadow .15s ease;
  position:relative;white-space:nowrap;
  flex:1 0 auto;
}
.start-btn:hover{
  transform:translateY(-2px) scale(1.05);
  box-shadow:0 8px 20px rgba(0,0,0,.6),inset 0 1px 0 rgba(255,255,255,.3);
  animation:none;
}
.start-btn:active{
  transform:translateY(0) scale(0.98);
}

/* Circular Progress for Button */
.progress-circle{
  width:24px;height:24px;border-radius:50%;
  background:conic-gradient(#10b981 0deg, #10b981 var(--progress-deg), rgba(255,255,255,0.2) var(--progress-deg));
  display:flex;align-items:center;justify-content:center;
  font-size:0.65rem;font-weight:800;color:#0D0F13;
}
.progress-circle::before{
  content:'';position:absolute;width:18px;height:18px;
  background:#10b981;border-radius:50%;z-index:1;
}
.progress-circle span{position:relative;z-index:2;}
@keyframes pulse{
  0%,100%{box-shadow:0 4px 12px rgba(138,147,166,.3);}
  50%{box-shadow:0 4px 16px rgba(138,147,166,.4);}
}
@keyframes slideIn{
  from{transform:translateX(400px);opacity:0;}
  to{transform:translateX(0);opacity:1;}
}
@keyframes slideOut{
  from{transform:translateX(0);opacity:1;}
  to{transform:translateX(400px);opacity:0;}
}

/* Tags */
.tags{
  display:flex;flex-wrap:wrap;gap:.6rem;
}
.tag{
  background:rgba(138,147,166,.2);color:#8A93A6;padding:.5rem 1rem;
  border-radius:2rem;font-size:.875rem;font-weight:600;
  cursor:pointer;transition:all .2s ease;letter-spacing:-0.01em;
  border:1px solid rgba(138,147,166,.25);
}
.tag:hover{background:rgba(138,147,166,.3);transform:translateY(-1px);border-color:rgba(192,199,212,.35);}
.tag.active{background:linear-gradient(135deg,#8A93A6,#C0C7D4);color:#0D0F13;
  box-shadow:0 2px 8px rgba(0,0,0,.3),inset 0 1px 0 rgba(255,255,255,.2);border-color:transparent;}

/* Build Modal - Replit Agent Style */
.modal{
  display:none !important;position:fixed;top:0;left:0;right:0;bottom:0;
  background:rgba(0,0,0,.95);z-index:1000;overflow:hidden;
}
.modal.active{display:flex !important;align-items:center;justify-content:center;}
.modal-content{
  background:linear-gradient(145deg, #0D0F13, #1A1D29);
  margin:0 auto;max-width:1400px;width:95%;height:90vh;
  border-radius:1rem;overflow:hidden;
  display:flex;flex-direction:column;
  border:1px solid rgba(147,51,234,.3);
  box-shadow:0 24px 64px rgba(0,0,0,.8),0 0 40px rgba(147,51,234,.2);
}
.modal-header{
  padding:1.5rem 2rem;background:rgba(28,31,43,.5);
  display:flex;align-items:center;justify-content:space-between;
  border-bottom:1px solid rgba(192,199,212,.08);
}
.modal-title{
  font-size:1.1rem;font-weight:600;color:#F4F6FB;letter-spacing:-0.02em;
  display:flex;align-items:center;gap:.75rem;
}
.status-badge{
  padding:.35rem .85rem;background:rgba(52,211,153,.15);
  color:#34D399;font-size:.75rem;border-radius:2rem;font-weight:600;
  border:1px solid rgba(52,211,153,.3);
}
.close-btn{
  background:rgba(138,147,166,.12);border:1px solid rgba(138,147,166,.2);
  color:#9CA3AF;cursor:pointer;width:2rem;height:2rem;border-radius:.5rem;
  font-size:1.2rem;display:flex;align-items:center;justify-content:center;
  transition:all .2s;
}
.close-btn:hover{background:rgba(138,147,166,.25);color:#C0C7D4;}

/* Split Panel Layout - Code + Preview */
.split-view{
  flex:1;display:flex;flex-direction:row;overflow:hidden;
}

/* Code Panel - Left Side (30% width) */
.code-panel{
  background:#0D0F13;width:30%;display:flex;flex-direction:column;
  border-right:1px solid rgba(192,199,212,.08);
  min-width:300px;
}
.panel-header{
  padding:0.6rem 1rem;background:rgba(28,31,43,.3);
  border-bottom:1px solid rgba(192,199,212,.08);
  font-size:.7rem;color:#8A93A6;font-weight:500;letter-spacing:0.01em;
  display:flex;align-items:center;justify-content:space-between;
}
.file-info{
  display:flex;align-items:center;gap:.4rem;color:#C0C7D4;font-size:.7rem;
}
.code-actions{
  display:flex;gap:.5rem;
}
.action-btn{
  background:rgba(138,147,166,.1);border:1px solid rgba(138,147,166,.2);
  color:#8A93A6;padding:.35rem .65rem;border-radius:.5rem;
  cursor:pointer;display:flex;align-items:center;gap:.3rem;
  transition:all .2s ease;font-size:.7rem;font-weight:500;
}
.action-btn:hover{
  background:rgba(138,147,166,.2);border-color:rgba(192,199,212,.3);
  color:#C0C7D4;transform:translateY(-1px);
}
.code-content{
  flex:1;overflow-y:auto;padding:1rem;
  font-family:'SF Mono',Monaco,Consolas,'Liberation Mono',Courier,monospace;
  font-size:.75rem;line-height:1.5;
  -webkit-font-smoothing:antialiased;
}
.placeholder-text{
  text-align:center;padding:4rem 2rem;color:#5A5F6E;
  font-size:.8rem;line-height:1.6;
}

/* Build Steps Display */
.build-steps{
  padding:0.8rem 1rem;background:#0A0B0F;
  border-bottom:1px solid rgba(192,199,212,.08);
  max-height:150px;overflow-y:auto;
  font-family:'SF Mono',Monaco,monospace;
  font-size:.7rem;line-height:1.4;
}
.step-line{
  color:#6B7280;margin:0.15rem 0;display:flex;align-items:flex-start;gap:0.5rem;
}
.step-line.active{color:#9333EA;}
.step-line.success{color:#34D399;}
.step-line .icon{min-width:12px;margin-top:2px;}
.step-line .text{flex:1;}

/* Preview Panel - Right Side (70% width - BIG!) */
.preview-panel{
  display:none;background:#0D0F13;flex-direction:column;width:70%;flex:1;
}
.preview-panel.active{display:flex;}
.preview-header{
  padding:0.6rem 1rem;background:rgba(28,31,43,.3);
  border-bottom:1px solid rgba(192,199,212,.08);
  font-size:.7rem;color:#8A93A6;font-weight:500;
  display:flex;align-items:center;justify-content:space-between;
}
.preview-tools{display:flex;gap:.5rem;}
.tool-btn{
  background:rgba(138,147,166,.1);border:1px solid rgba(138,147,166,.2);
  padding:.35rem .65rem;border-radius:.5rem;cursor:pointer;
  font-size:.7rem;transition:all .2s;color:#8A93A6;
}
.tool-btn:hover{background:rgba(138,147,166,.2);transform:scale(1.05);color:#C0C7D4;}
.preview-content{
  flex:1;overflow:hidden;background:#FFFFFF;
}
.preview-placeholder{
  display:flex;align-items:center;justify-content:center;
  height:100%;color:#6B7280;font-size:.75rem;background:#0D0F13;
}
.preview-iframe{
  width:100%;height:100%;border:none;background:#FFFFFF;
}

/* Build Status */
.build-status{
  padding:.7rem 1.2rem;background:#252938;
  border-top:1px solid #2E3244;
  font-size:.875rem;color:#9CA3AF;font-weight:500;
  display:flex;align-items:center;gap:.75rem;letter-spacing:-0.005em;
}
.spinner{
  display:inline-block;width:14px;height:14px;
  border:2px solid #4B5563;border-top-color:#8A93A6;
  border-radius:50%;animation:spin 0.6s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg);}}
.status-complete{color:#34D399;}
.cursor{
  display:inline-block;width:2px;height:14px;
  background:#8A93A6;animation:blink 1s infinite;
  margin-left:2px;
}
@keyframes blink{0%,50%{opacity:1;}51%,100%{opacity:0;}}

/* ===== NEW UI POLISH STYLES ===== */

/* Feature Badges - Showcase #1 Features */
.feature-badge{
  background:rgba(13,15,19,0.95);
  backdrop-filter:blur(20px);
  padding:0.4rem 0.75rem;
  border-radius:2rem;
  display:flex;
  align-items:center;
  gap:0.35rem;
  font-size:0.7rem;
  font-weight:700;
  border:1px solid rgba(147,51,234,0.3);
  box-shadow:0 4px 12px rgba(0,0,0,0.4),0 0 20px rgba(147,51,234,0.1);
  transition:all 0.3s cubic-bezier(0.4,0,0.2,1);
  cursor:help;
}
.feature-badge:hover{
  transform:translateY(-2px) scale(1.05);
  box-shadow:0 6px 16px rgba(0,0,0,0.5),0 0 30px rgba(147,51,234,0.2);
  border-color:rgba(147,51,234,0.5);
}
.badge-icon{
  font-size:0.9rem;
  animation:float 3s ease-in-out infinite;
}
.badge-text{
  color:#C0C7D4;
  letter-spacing:-0.01em;
}

/* Icon Buttons */
.icon-btn{
  background:rgba(13,15,19,0.8);
  backdrop-filter:blur(10px);
  border:1px solid rgba(147,51,234,0.3);
  color:#C0C7D4;
  width:2rem;
  height:2rem;
  border-radius:0.5rem;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:0.9rem;
  font-weight:700;
  transition:all 0.3s cubic-bezier(0.4,0,0.2,1);
}
.icon-btn:hover{
  background:rgba(147,51,234,0.2);
  border-color:rgba(147,51,234,0.6);
  transform:scale(1.1);
  box-shadow:0 4px 12px rgba(147,51,234,0.3);
}

/* Enhanced Animations */
@keyframes pulse-soft{
  0%,100%{opacity:1;transform:scale(1);}
  50%{opacity:0.9;transform:scale(1.02);}
}
@keyframes float{
  0%,100%{transform:translateY(0px);}
  50%{transform:translateY(-3px);}
}
@keyframes slideInUp{
  from{transform:translateY(20px);opacity:0;}
  to{transform:translateY(0);opacity:1;}
}
@keyframes shimmer{
  0%{background-position:-1000px 0;}
  100%{background-position:1000px 0;}
}

/* Toast Notifications - Enhanced */
.toast{
  position:fixed;
  bottom:2rem;
  right:2rem;
  background:linear-gradient(135deg, rgba(35,15,42,0.98), rgba(59,30,70,0.98));
  backdrop-filter:blur(20px);
  color:#F4F6FB;
  padding:1rem 1.5rem;
  border-radius:0.75rem;
  box-shadow:0 8px 32px rgba(0,0,0,0.6),0 0 40px rgba(147,51,234,0.2);
  border:1px solid rgba(147,51,234,0.3);
  z-index:10000;
  min-width:300px;
  animation:slideInUp 0.3s cubic-bezier(0.4,0,0.2,1);
  transition:all 0.3s ease;
}
.toast:hover{
  transform:translateY(-4px);
  box-shadow:0 12px 40px rgba(0,0,0,0.7),0 0 50px rgba(147,51,234,0.3);
}
.toast.success{border-left:4px solid #10B981;}
.toast.error{border-left:4px solid #EF4444;}
.toast.warning{border-left:4px solid #F59E0B;}
.toast.info{border-left:4px solid #3B82F6;}

/* Loading Indicator - AI Thinking */
.ai-thinking{
  display:flex;
  align-items:center;
  gap:0.75rem;
  padding:1rem;
  background:rgba(147,51,234,0.1);
  border:1px solid rgba(147,51,234,0.3);
  border-radius:0.75rem;
  margin:1rem 0;
}
.thinking-dots{
  display:flex;
  gap:0.3rem;
}
.thinking-dot{
  width:8px;
  height:8px;
  border-radius:50%;
  background:linear-gradient(135deg,#9333EA,#A855F7);
  animation:bounce 1.4s infinite ease-in-out;
}
.thinking-dot:nth-child(1){animation-delay:-0.32s;}
.thinking-dot:nth-child(2){animation-delay:-0.16s;}
@keyframes bounce{
  0%,80%,100%{transform:scale(0);}
  40%{transform:scale(1);}
}

/* Keyboard Shortcuts Hint */
.kbd-hint{
  position:fixed;
  bottom:1rem;
  left:50%;
  transform:translateX(-50%);
  background:rgba(13,15,19,0.95);
  backdrop-filter:blur(20px);
  padding:0.5rem 1rem;
  border-radius:2rem;
  border:1px solid rgba(147,51,234,0.3);
  font-size:0.75rem;
  color:#8A93A6;
  z-index:100;
  animation:slideInUp 0.5s ease 2s;
  box-shadow:0 4px 20px rgba(0,0,0,0.5);
}
.kbd{
  background:rgba(147,51,234,0.2);
  border:1px solid rgba(147,51,234,0.4);
  padding:0.15rem 0.4rem;
  border-radius:0.25rem;
  font-weight:700;
  color:#C0C7D4;
  margin:0 0.2rem;
}

/* Mobile Responsiveness Improvements */
@media (max-width:768px){
  .container{max-width:100%;padding:0;}
  header{padding:1rem 0.75rem 2.5rem 0.75rem;border-radius:0;}
  .card{margin:1rem;padding:1.25rem 1rem;}
  .feature-badge{font-size:0.65rem;padding:0.3rem 0.6rem;}
  .badge-text{display:none;}
  .icon-btn{width:1.75rem;height:1.75rem;font-size:0.8rem;}
  .toast{right:1rem;bottom:1rem;min-width:280px;}
  .kbd-hint{display:none;}
}

/* Better touch targets for mobile */
@media (hover:none) and (pointer:coarse){
  button,a,.tag,.icon{min-height:44px;min-width:44px;}
}

/* Bottom nav */
nav{
  display:flex;justify-content:space-around;padding:0.75rem 0;
  border-top:1px solid rgba(138,147,166,.2);color:#5A5F6E;
  margin-top:1rem;
}
nav a{
  color:#5A5F6E;font-size:.875rem;text-align:center;
  display:flex;flex-direction:column;gap:.3rem;text-decoration:none;
  transition:color .2s ease;font-weight:500;letter-spacing:-0.01em;
}
nav a.active{color:#C0C7D4;font-weight:600;}
nav a:hover{color:#8A93A6;}
nav svg{width:1.2rem;height:1.2rem;fill:currentColor;}
</style>
</head>
<body>

<!-- Animated Particle Background -->
<canvas id="particles-canvas"></canvas>

<!-- Top Badge Strip - Fixed to viewport, never overlaps content -->
<div style="position:fixed;top:1rem;right:1rem;display:flex;gap:0.4rem;flex-wrap:wrap;z-index:10000;max-width:400px;justify-content:flex-end;">
  <div class="feature-badge" title="Industry-leading bug detection">
    <span class="badge-icon">‚úÖ</span>
    <span class="badge-text">99% Accuracy</span>
  </div>
  <div class="feature-badge" title="Enterprise-grade security">
    <span class="badge-icon">üîí</span>
    <span class="badge-text">Secured</span>
  </div>
  <div id="versionBadge" style="font-size:0.7rem;color:#9333EA;background:rgba(13,15,19,0.9);padding:0.3rem 0.6rem;border-radius:0.5rem;border:1px solid rgba(147,51,234,0.5);backdrop-filter:blur(10px);animation:pulse-soft 3s infinite;">v5.1.0</div>
</div>

<!-- User Status - Fixed to viewport below badges -->
<div style="position:fixed;top:3.5rem;right:1rem;z-index:10000;">
  <div id="userStatus" style="font-size:0.7rem;display:none;padding:0.3rem 0.6rem;border-radius:0.5rem;backdrop-filter:blur(10px);cursor:pointer;" onclick="showUserMenu()"></div>
</div>

<div class="container">

  <!-- Header -->
  <header>
    <div class="workspace">Your workspace</div>
    <h1>üöÄ Super Agent</h1>
    <p>Build production-ready apps & websites</p>
    
    <!-- Quick Actions - Top Left (offset to avoid workspace badge overlap) -->
    <div style="position:absolute;top:3.5rem;left:1rem;display:flex;gap:0.4rem;">
      <button onclick="showOnboarding()" class="icon-btn" title="Tutorial (?)">
        <span>?</span>
      </button>
      <button onclick="showComparison()" class="icon-btn" title="Why SuperAgent?">
        <span>‚ö°</span>
      </button>
    </div>
    
    <!-- Agent Mode - Bottom Right -->
    <div style="position:absolute;bottom:0.3rem;right:1rem;">
      <button onclick="showAgentMode()" style="background:linear-gradient(135deg,#f59e0b,#ef4444);color:white;border:none;padding:0.5rem 1rem;border-radius:0.5rem;cursor:pointer;font-weight:700;font-size:0.75rem;box-shadow:0 4px 12px rgba(245,158,11,0.4);transition:all 0.3s ease;">ü§ñ AGENT MODE</button>
    </div>
    
    <!-- Dev Tools & Auth - Bottom Left -->
    <div style="position:absolute;bottom:0.3rem;left:1rem;display:flex;gap:0.5rem;">
      <button onclick="showDevTools()" style="background:linear-gradient(135deg,#9333EA,#A855F7);color:white;border:none;padding:0.5rem 1rem;border-radius:0.5rem;cursor:pointer;font-weight:600;font-size:0.75rem;">‚ö° Dev Tools</button>
      <button onclick="showMultiplayerModal()" style="background:linear-gradient(135deg,#10B981,#34D399);color:white;border:none;padding:0.5rem 1rem;border-radius:0.5rem;cursor:pointer;font-weight:600;font-size:0.75rem;">üë• Multiplayer</button>
      <button id="authButton" onclick="handleAuth()" style="display:none;background:linear-gradient(135deg,#F59E0B,#FBBF24);color:white;border:none;padding:0.5rem 1rem;border-radius:0.5rem;cursor:pointer;font-weight:600;font-size:0.75rem;">üîê Login</button>
    </div>
  </header>

  <!-- Card -->
  <section class="card">
    <div class="greeting">What would you like to build today?</div>

    <!-- Conversation messages (hidden by default, shown during planning) -->
    <div id="conversationMessages" style="display:none;max-height:400px;overflow-y:auto;margin-bottom:1rem;padding:1rem;background:rgba(35,15,42,0.3);border-radius:0.75rem;border:1px solid rgba(147,51,234,.2);"></div>

    <textarea id="ideaInput" placeholder="Describe your app idea in detail... e.g., 'Build a task manager with user authentication and real-time updates'"></textarea>

    <div class="toolbar">
      <span class="icon" title="Edit code" onclick="showNotification('Click the edit button in generated code', 'info')">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
          <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
        </svg>
      </span>
      <input type="file" id="fileInput" accept=".js,.py,.html,.css,.json,.txt" style="display:none" onchange="handleFileUpload(event)">
      <span class="icon" title="Upload code file" onclick="document.getElementById('fileInput').click()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
          <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/>
        </svg>
      </span>
      <span class="icon" title="Browse code templates" onclick="openTemplatesModal()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
          <path d="M4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-1 9H9V9h10v2zm-4 4H9v-2h6v2zm4-8H9V5h10v2z"/>
        </svg>
      </span>
      <span class="icon" title="Customize theme" onclick="openThemeCustomizer()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9c.83 0 1.5-.67 1.5-1.5 0-.39-.15-.74-.39-1.01-.23-.26-.38-.61-.38-.99 0-.83.67-1.5 1.5-1.5H16c2.76 0 5-2.24 5-5 0-4.42-4.03-8-9-8zm-5.5 9c-.83 0-1.5-.67-1.5-1.5S5.67 9 6.5 9 8 9.67 8 10.5 7.33 12 6.5 12zm3-4C8.67 8 8 7.33 8 6.5S8.67 5 9.5 5s1.5.67 1.5 1.5S10.33 8 9.5 8zm5 0c-.83 0-1.5-.67-1.5-1.5S13.67 5 14.5 5s1.5.67 1.5 1.5S15.33 8 14.5 8zm3 4c-.83 0-1.5-.67-1.5-1.5S16.67 9 17.5 9s1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/>
        </svg>
      </span>
      
      <!-- Plan Mode Toggle -->
      <label class="mode-toggle" title="Plan first before building (explains what will be built and suggests features)">
        <input type="checkbox" id="planModeToggle" onchange="togglePlanMode()">
        <span class="mode-label">Plan Mode</span>
      </label>
      
      <!-- Enterprise Mode Toggle -->
      <label class="mode-toggle" title="Enterprise-grade build with checkpoints, multi-file projects, testing, and security scanning (takes 2-5 min)">
        <input type="checkbox" id="enterpriseModeToggle" onchange="toggleEnterpriseMode()">
        <span class="mode-label" style="background:linear-gradient(135deg,#10B981,#34D399);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">üöÄ Enterprise</span>
      </label>
      
      <button class="start-btn" onclick="startBuild(event)">
        <span>‚ñ∂</span>
        <span id="buildBtnText">Start Building</span>
      </button>
    </div>

    <!-- Build Modes Selector -->
    <div style="display:flex;flex-direction:column;gap:0.75rem;">
      <div style="font-size:0.875rem;color:#C0C7D4;font-weight:600;letter-spacing:-0.01em;">Build Mode:</div>
      <div style="display:flex;gap:0.75rem;">
        <div class="build-mode-option active" data-mode="design" onclick="selectBuildMode('design')" style="flex:1;cursor:pointer;padding:1rem;border-radius:0.75rem;border:2px solid rgba(147,51,234,0.4);background:linear-gradient(135deg,rgba(147,51,234,0.15),rgba(168,85,247,0.15));transition:all 0.2s;">
          <div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.5rem;">
            <div style="width:1.5rem;height:1.5rem;background:linear-gradient(135deg,#9333EA,#A855F7);border-radius:0.375rem;display:flex;align-items:center;justify-content:center;font-size:0.875rem;">‚ú®</div>
            <div style="font-weight:700;color:#F4F6FB;font-size:0.95rem;">Start with Design</div>
          </div>
          <div style="font-size:0.8rem;color:#8A93A6;line-height:1.4;">Clickable prototype in ~3 min ‚Ä¢ Visualize before building</div>
        </div>
        <div class="build-mode-option" data-mode="full" onclick="selectBuildMode('full')" style="flex:1;cursor:pointer;padding:1rem;border-radius:0.75rem;border:2px solid rgba(138,147,166,0.2);background:rgba(138,147,166,0.08);transition:all 0.2s;">
          <div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.5rem;">
            <div style="width:1.5rem;height:1.5rem;background:rgba(138,147,166,0.3);border-radius:0.375rem;display:flex;align-items:center;justify-content:center;font-size:0.875rem;">‚ö°</div>
            <div style="font-weight:700;color:#C0C7D4;font-size:0.95rem;">Build Full App</div>
          </div>
          <div style="font-size:0.8rem;color:#8A93A6;line-height:1.4;">Full functionality in ~10 min ‚Ä¢ Working app from start</div>
        </div>
      </div>
    </div>

    <div class="tags">
      <div class="tag active" data-type="webapp">Web App</div>
      <div class="tag" data-type="api">API Service</div>
      <div class="tag" data-type="tool">CLI Tool</div>
      <div class="tag" data-type="game">Game</div>
      <div class="tag" data-type="automation">Automation</div>
    </div>
  </section>

  <!-- Bottom nav -->
  <nav>
    <a href="#" class="active">
      <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
      <span>Create</span>
    </a>
    <a href="#" onclick="event.preventDefault();showPricing();">
      <svg viewBox="0 0 24 24"><path d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"/></svg>
      <span>Pricing</span>
    </a>
    <a href="#" onclick="event.preventDefault();viewHistory();">
      <svg viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/></svg>
      <span>History</span>
    </a>
  </nav>

</div>

<!-- Build Modal - Clean & Sophisticated -->
<div class="modal" id="buildModal" style="display:none !important;">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">
        <span id="statusText">Generating Code</span>
        <span class="status-badge">Ready</span>
      </div>
      <button class="close-btn" onclick="closeModal()">√ó</button>
    </div>
    
    <div class="split-view">
      <!-- Code Panel - Clean Single View -->
      <div class="code-panel">
        <!-- Build Steps Log -->
        <div class="build-steps" id="buildSteps">
          <div class="step-line"><span class="icon">‚ñ∏</span><span class="text">Initializing build process...</span></div>
        </div>
        
        <div class="panel-header">
          <div class="file-info">
            <span style="color:#34D399;">‚óè</span>
            <span id="currentFileName">Generated Code</span>
          </div>
          <div class="code-actions">
            <button class="action-btn" onclick="copyCode()">Copy</button>
            <button class="action-btn" onclick="downloadCode()">Download</button>
          </div>
        </div>
        <div class="code-content" id="codeContent">
          <div class="placeholder-text">
            Your AI-generated code will stream here...<br>
            <span style="color:#8A93A6;font-size:.85rem;">This tool generates production-ready code that you can run as working applications</span>
          </div>
        </div>
      </div>
      
      <!-- Preview Panel (Hidden) -->
      <div class="preview-panel">
        <div class="preview-header">
          <span>Live Preview</span>
        </div>
        <div class="preview-content" id="previewContent">
          <div class="preview-placeholder">
            Preview will appear here...
          </div>
        </div>
      </div>
    </div>
    
    <div class="build-status" id="buildStatus" style="display:none;">
      <span class="spinner"></span>
      <span id="buildStatusText">Starting build...</span>
    </div>
  </div>
</div>

<script type="text/javascript">
// CONFIGURATION: Set your API key here to avoid being prompted each time
// Get your SUPERAGENT_API_KEY from the Secrets panel (left sidebar)
window.SUPERAGENT_API_KEY = '';  // Paste your API key here, or leave empty to be prompted

let selectedType = 'webapp';
let selectedBuildMode = 'design';  // 'design' or 'full'
let buildInProgress = false;
let recognition = null;
let isRecording = false;
let currentGeneratedCode = '';
let currentPrompt = '';
let generationHistory = JSON.parse(localStorage.getItem('superagent_history') || '[]');

// Check if user is admin (unlimited access)
function isAdminUser() {
  const adminToken = localStorage.getItem('admin_token');
  return adminToken !== null && adminToken !== '';
}

// Check if regular user is logged in
function isAuthenticatedUser() {
  const userToken = localStorage.getItem('userToken');
  return userToken !== null && userToken !== '';
}

// Get user tier (admin = unlimited, authenticated users = unlimited)
function getUserTier() {
  if (isAdminUser()) {
    return 'unlimited'; // Admin has unlimited access
  }
  if (isAuthenticatedUser()) {
    return localStorage.getItem('userTier') || 'free';
  }
  return localStorage.getItem('user_tier') || 'free';
}

// Get username
function getUsername() {
  if (isAdminUser()) {
    return 'Admin';
  }
  if (isAuthenticatedUser()) {
    return localStorage.getItem('username') || 'User';
  }
  return null;
}

// Get authentication headers for API calls
function getAuthHeaders() {
  const headers = {
    'Content-Type': 'application/json'
  };
  
  // Add admin token if available
  const adminToken = localStorage.getItem('admin_token');
  if (adminToken) {
    headers['Authorization'] = `Bearer ${adminToken}`;
    return headers;
  }
  
  // Add user token if available
  const userToken = localStorage.getItem('userToken');
  if (userToken) {
    headers['Authorization'] = `Bearer ${userToken}`;
    return headers;
  }
  
  return headers;
}

// Handle authentication button click
function handleAuth() {
  window.location.href = '/login.html';
}

// Show user menu
function showUserMenu() {
  const modal = document.getElementById('buildModal');
  const codeContent = document.getElementById('codeContent');
  
  const username = getUsername();
  const tier = getUserTier();
  const isAdmin = isAdminUser();
  
  codeContent.innerHTML = `
    <div style="padding:2rem;color:#C0C7D4;overflow-y:auto;height:100%;">
      <h2 style="color:#9333EA;margin:0 0 1rem 0;">üë§ Account</h2>
      
      <div style="background:rgba(13,15,19,0.6);border-radius:1rem;padding:1.5rem;margin-bottom:1.5rem;border:1px solid rgba(147,51,234,0.3);">
        <div style="margin-bottom:1rem;">
          <div style="color:#8A93A6;font-size:0.85rem;margin-bottom:0.3rem;">Username</div>
          <div style="color:#C0C7D4;font-weight:600;font-size:1.1rem;">${username}</div>
        </div>
        <div style="margin-bottom:1rem;">
          <div style="color:#8A93A6;font-size:0.85rem;margin-bottom:0.3rem;">Access Level</div>
          <div style="color:${isAdmin ? '#F59E0B' : '#10B981'};font-weight:700;font-size:1.1rem;text-transform:uppercase;">
            ${isAdmin ? 'üîë ADMIN (UNLIMITED)' : '‚úÖ ' + tier.toUpperCase() + ' (UNLIMITED)'}
          </div>
        </div>
        <div>
          <div style="color:#8A93A6;font-size:0.85rem;margin-bottom:0.3rem;">Features</div>
          <div style="color:#10B981;font-weight:600;">All features unlocked üöÄ</div>
        </div>
      </div>
      
      <button onclick="logoutUser()" style="width:100%;background:linear-gradient(135deg,#EF4444,#DC2626);color:white;border:none;padding:1rem;border-radius:0.75rem;cursor:pointer;font-weight:700;font-size:1rem;margin-bottom:1rem;">
        üö™ Logout
      </button>
      
      ${isAdmin ? `
        <button onclick="window.location.href='/admin'" style="width:100%;background:linear-gradient(135deg,#9333EA,#A855F7);color:white;border:none;padding:1rem;border-radius:0.75rem;cursor:pointer;font-weight:700;font-size:1rem;">
          üîß Admin Panel
        </button>
      ` : ''}
    </div>
  `;
  
  modal.classList.add('active');
}

// Logout user
function logoutUser() {
  localStorage.removeItem('userToken');
  localStorage.removeItem('username');
  localStorage.removeItem('userTier');
  localStorage.removeItem('admin_token');
  window.location.href = '/login.html';
}

// Initialize app on load
document.addEventListener('DOMContentLoaded', function() {
  const modal = document.getElementById('buildModal');
  modal.classList.remove('active');
  modal.style.cssText = 'display: none !important;';
  
  const userStatus = document.getElementById('userStatus');
  const authButton = document.getElementById('authButton');
  
  // Check if admin user and show unlimited badge
  if (isAdminUser()) {
    console.log('‚úÖ Admin user detected - Unlimited access enabled');
    
    // Update version badge to show admin status
    const versionBadge = document.getElementById('versionBadge');
    if (versionBadge) {
      versionBadge.innerHTML = 'üîë ADMIN';
      versionBadge.style.background = 'linear-gradient(135deg,#F59E0B,#EF4444)';
      versionBadge.style.color = 'white';
      versionBadge.style.borderColor = '#F59E0B';
      versionBadge.title = 'Admin Mode: Unlimited Access';
    }
    
    // Show admin status badge
    if (userStatus) {
      userStatus.innerHTML = 'üë§ Admin';
      userStatus.style.background = 'linear-gradient(135deg,#F59E0B,#EF4444)';
      userStatus.style.color = 'white';
      userStatus.style.border = '1px solid #F59E0B';
      userStatus.style.display = 'block';
      userStatus.title = 'Click to view account';
    }
    
    setTimeout(() => {
      showNotification('Welcome Admin! You have unlimited access to all features üöÄ', 'success');
    }, 1000);
  } else if (isAuthenticatedUser()) {
    console.log('‚úÖ User authenticated - Unlimited access enabled');
    
    const username = getUsername();
    const tier = getUserTier();
    
    // Show user status badge
    if (userStatus) {
      userStatus.innerHTML = `üë§ ${username}`;
      userStatus.style.background = 'linear-gradient(135deg,#10B981,#34D399)';
      userStatus.style.color = 'white';
      userStatus.style.border = '1px solid #10B981';
      userStatus.style.display = 'block';
      userStatus.title = 'Click to view account';
    }
    
    setTimeout(() => {
      showNotification(`Welcome ${username}! You have unlimited access to all features üöÄ`, 'success');
    }, 1000);
  } else {
    // Show login button
    if (authButton) {
      authButton.style.display = 'inline-block';
    }
  }
  
  checkBackendStatus();
  initVoiceRecognition();
});

// Initialize Web Speech API for voice input
function initVoiceRecognition() {
  if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.continuous = false;
    recognition.interimResults = false;
    recognition.lang = 'en-US';
    
    recognition.onresult = function(event) {
      const transcript = event.results[0][0].transcript;
      const ideaInput = document.getElementById('ideaInput');
      if (ideaInput.value.trim()) {
        ideaInput.value += ' ' + transcript;
      } else {
        ideaInput.value = transcript;
      }
      showNotification('Voice input captured: "' + transcript + '"', 'success');
    };
    
    recognition.onerror = function(event) {
      console.error('Speech recognition error:', event.error);
      if (event.error !== 'no-speech' && event.error !== 'aborted') {
        showNotification('Voice input error: ' + event.error, 'error');
      }
      stopVoiceRecording();
    };
    
    recognition.onend = function() {
      stopVoiceRecording();
    };
  }
}

// Toggle voice input recording
function toggleVoiceInput() {
  if (!recognition) {
    showNotification('Voice input not supported in this browser. Try Chrome or Edge.', 'warning');
    return;
  }
  
  if (isRecording) {
    recognition.stop();
  } else {
    try {
      recognition.start();
      isRecording = true;
      document.getElementById('voiceBtn').classList.add('recording');
      showNotification('üé§ Listening... Speak your idea now!', 'info');
    } catch (error) {
      showNotification('Could not start voice input. Please try again.', 'error');
    }
  }
}

function stopVoiceRecording() {
  isRecording = false;
  document.getElementById('voiceBtn').classList.remove('recording');
}

// Helper function to escape HTML
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Check backend status silently
async function checkBackendStatus() {
  try {
    const response = await fetch('/health', { cache: 'no-cache' });
    if (response.ok) {
      // Backend online - ready to use
      return true;
    }
  } catch (error) {
    // Backend offline - will show error when user tries to build
  }
  return false;
}

// Show professional notification
function showNotification(message, type = 'info') {
  const notification = document.createElement('div');
  const icons = {
    success: '‚úÖ',
    error: '‚ùå',
    warning: '‚ö†Ô∏è',
    info: '‚ÑπÔ∏è'
  };
  
  // Use the new enhanced .toast CSS class
  notification.className = `toast ${type}`;
  notification.innerHTML = `
    <div style="display:flex;align-items:center;gap:0.75rem;">
      <span style="font-size:1.25rem;">${icons[type]}</span>
      <span style="flex:1;">${message}</span>
    </div>
  `;
  
  document.body.appendChild(notification);
  
  // Auto-remove after 4 seconds with fade out
  setTimeout(() => {
    notification.style.opacity = '0';
    notification.style.transform = 'translateY(20px)';
    setTimeout(() => notification.remove(), 300);
  }, 4000);
}

// Tag selection
document.querySelectorAll('.tag').forEach(t=>{
  t.addEventListener('click',()=>{
    document.querySelectorAll('.tag').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    selectedType = t.dataset.type;
  });
});

// Build Mode Selection
function selectBuildMode(mode) {
  selectedBuildMode = mode;
  document.querySelectorAll('.build-mode-option').forEach(option => {
    const isActive = option.dataset.mode === mode;
    if (isActive) {
      option.classList.add('active');
      option.style.border = '2px solid rgba(147,51,234,0.4)';
      option.style.background = 'linear-gradient(135deg,rgba(147,51,234,0.15),rgba(168,85,247,0.15))';
      option.querySelector('div > div:first-child').style.background = 'linear-gradient(135deg,#9333EA,#A855F7)';
      option.querySelector('div > div:last-child').style.color = '#F4F6FB';
    } else {
      option.classList.remove('active');
      option.style.border = '2px solid rgba(138,147,166,0.2)';
      option.style.background = 'rgba(138,147,166,0.08)';
      option.querySelector('div > div:first-child').style.background = 'rgba(138,147,166,0.3)';
      option.querySelector('div > div:last-child').style.color = '#C0C7D4';
    }
  });
}

// Sample code files
const codeFiles = {
  'app.py': `from flask import Flask, render_template, request
from fractions import Fraction

app = Flask(__name__)

@app.route('/', methods=['GET', 'POST'])
def index():
    result = None
    if request.method == 'POST':
        frac1 = request.form.get('frac1')
        frac2 = request.form.get('frac2')
        if frac1 and frac2:
            try:
                f1 = Fraction(frac1)
                f2 = Fraction(frac2)
                result = {
                    'add': f1 + f2,
                    'subtract': f1 - f2,
                    'multiply': f1 * f2,
                    'divide': f1 / f2 if f2 != 0 else 'Error'
                }
            except Exception as e:
                result = {'error': str(e)}
    return render_template('index.html', result=result)

if __name__ == '__main__':
    app.run(debug=True)`,
  
  'templates/index.html': `<!DOCTYPE html>
<html>
<head>
    <title>Fraction Calculator</title>
    <style>
        body { font-family: Arial; background: #f5f5f5; }
        .container { max-width: 600px; margin: 50px auto; 
                    background: white; padding: 30px; 
                    border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #C0C7D4; }
        input { padding: 10px; margin: 5px; border: 1px solid #ddd; 
               border-radius: 6px; width: 200px; }
        button { padding: 12px 24px; background: linear-gradient(135deg,#8A93A6,#C0C7D4); 
                color: white; border: none; border-radius: 6px; }
        .result { margin-top: 20px; padding: 15px; 
                 background: #f0f4ff; border-radius: 6px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üßÆ Fraction Calculator</h1>
        <form method="POST">
            <input name="frac1" placeholder="1/2" required>
            <input name="frac2" placeholder="1/3" required>
            <button>Calculate</button>
        </form>
        {% if result %}
            <div class="result">
                <strong>Results:</strong><br>
                Add: {{ result.add }}<br>
                Multiply: {{ result.multiply }}
            </div>
        {% endif %}
    </div>
</body>
</html>`
};

const buildSteps = [
  { message: 'ü§î Understanding your requirements...', duration: 2000, steps: [
    'Analyzing prompt',
    'Identifying app type',
    'Extracting requirements'
  ]},
  { message: 'üìã Planning project architecture...', duration: 3000, steps: [
    'Designing file structure',
    'Selecting frameworks',
    'Planning dependencies'
  ]},
  { message: 'üíª Writing code with AI...', duration: 5000, steps: [
    'Generating main application file',
    'Creating HTML templates',
    'Writing Python backend',
    'Adding styling & assets'
  ]},
  { message: 'üîç Reviewing code quality...', duration: 2000, steps: [
    'Checking syntax',
    'Validating structure',
    'Optimizing code'
  ]},
  { message: 'üß™ Testing the implementation...', duration: 2000, steps: [
    'Running syntax checks',
    'Verifying imports',
    'Testing endpoints'
  ]},
  { message: '‚úÖ Build complete!', duration: 1000, steps: [
    'Finalizing build',
    'Ready to deploy'
  ]}
];

// Helper function to add build step log
function addBuildStep(message, status = 'active') {
  const stepsContainer = document.getElementById('buildSteps');
  const stepDiv = document.createElement('div');
  stepDiv.className = `step-line ${status}`;
  const icon = status === 'success' ? '‚úì' : status === 'active' ? '‚ñ∏' : '‚óã';
  stepDiv.innerHTML = `<span class="icon">${icon}</span><span class="text">${message}</span>`;
  stepsContainer.appendChild(stepDiv);
  stepsContainer.scrollTop = stepsContainer.scrollHeight;
}

// Helper function to update last step status
function updateLastStep(status) {
  const stepsContainer = document.getElementById('buildSteps');
  const lastStep = stepsContainer.lastElementChild;
  if (lastStep) {
    lastStep.className = `step-line ${status}`;
    const icon = status === 'success' ? '‚úì' : status === 'active' ? '‚ñ∏' : '‚óã';
    lastStep.querySelector('.icon').textContent = icon;
  }
}

// Toggle Plan Mode - changes button text and behavior
function togglePlanMode() {
  const planModeCheckbox = document.getElementById('planModeToggle');
  const enterpriseCheckbox = document.getElementById('enterpriseModeToggle');
  const buildBtnText = document.getElementById('buildBtnText');
  
  if (planModeCheckbox.checked && enterpriseCheckbox.checked) {
    buildBtnText.textContent = 'üß† Plan ‚Üí üöÄ Enterprise Build';
    showNotification('Plan + Enterprise Mode - I\'ll plan first, then build production-ready code', 'success');
  } else if (planModeCheckbox.checked) {
    buildBtnText.textContent = 'Create Plan';
    showNotification('Plan Mode enabled - I will explain what I\'ll build first', 'info');
  } else if (enterpriseCheckbox.checked) {
    buildBtnText.textContent = 'üöÄ Enterprise Build (2-5 min)';
  } else {
    buildBtnText.textContent = 'Start Building';
  }
}

function toggleEnterpriseMode() {
  const enterpriseCheckbox = document.getElementById('enterpriseModeToggle');
  const planCheckbox = document.getElementById('planModeToggle');
  const buildBtnText = document.getElementById('buildBtnText');
  
  if (enterpriseCheckbox.checked && planCheckbox.checked) {
    buildBtnText.textContent = 'üß† Plan ‚Üí üöÄ Enterprise Build';
    showNotification('Plan + Enterprise Mode - I\'ll plan first, then build production-ready code', 'success');
  } else if (enterpriseCheckbox.checked) {
    buildBtnText.textContent = 'üöÄ Enterprise Build (2-5 min)';
    showNotification('Enterprise Mode enabled - Multi-file projects with checkpoints, testing & security scanning', 'success');
  } else if (planCheckbox.checked) {
    buildBtnText.textContent = 'Create Plan';
  } else {
    buildBtnText.textContent = 'Start Building';
  }
}

async function startBuild(event) {
  const btn = event.target.closest('.start-btn');
  const idea = document.getElementById('ideaInput').value.trim();
  
  if (!idea) {
    showNotification('Please describe your idea first', 'warning');
    return;
  }
  
  if (buildInProgress) {
    showNotification('Build already in progress', 'info');
    return;
  }
  buildInProgress = true;
  
  const planModeEnabled = document.getElementById('planModeToggle').checked;
  const enterpriseModeEnabled = document.getElementById('enterpriseModeToggle').checked;
  
  // APPROVAL GATE: Handle conversation revisions (streaming via /plan/continue)
  if (conversationActive && planModeEnabled && conversationContext.status === 'planned' && conversationContext.planId) {
    // User typed instead of using buttons - revise the plan with streaming
    addInlineMessage('user', idea);
    addInlineMessage('ai', 'Refining the plan based on your feedback...', 'thinking');
    
    try {
      // Call /plan/continue endpoint to maintain state and streaming
      const response = await fetch(`/plan/continue/${conversationContext.planId}`, {
        method: 'POST',
        headers: getAuthHeaders(),
        body: JSON.stringify({ message: idea })
      });
      
      if (!response.ok) throw new Error('Failed to continue conversation');
      const data = await response.json();
      
      // Reset status to trigger streaming
      conversationContext.status = 'planning';
      
      // Stream the updated plan
      streamPlan(conversationContext.planId);
      
      document.getElementById('ideaInput').value = '';
      buildInProgress = false;
      return;
      
    } catch (error) {
      addInlineMessage('ai', `‚ùå Error: ${error.message}`);
      buildInProgress = false;
      return;
    }
  }
  
  // ===== STREAMING CONVERSATIONAL PLANNING (Replit Agent Style) =====
  if (planModeEnabled && !conversationContext.status) {
    // Start new plan session with streaming
    conversationActive = true;
    conversationContext = { originalRequest: idea, language: 'python' };
    
    // Add user's message inline
    addInlineMessage('user', idea);
    addInlineMessage('ai', 'Analyzing your request...', 'thinking');
    
    try {
      // Start plan session
      const response = await fetch('/plan/start', {
        method: 'POST',
        headers: getAuthHeaders(),
        body: JSON.stringify({ instruction: idea, language: 'python' })
      });
      
      if (!response.ok) throw new Error('Failed to start plan session');
      const data = await response.json();
      
      // Store plan_id for conversation
      conversationContext.planId = data.plan_id;
      
      // Start streaming the plan
      streamPlan(data.plan_id);
      
      buildInProgress = false;
      
      if (btn) {
        btn.style.background = 'linear-gradient(135deg,#8A93A6,#C0C7D4)';
        btn.innerHTML = '<span>‚ñ∂</span><span id="buildBtnText">Continue</span>';
      }
      
      return;
      
    } catch (error) {
      addInlineMessage('ai', `‚ùå Error: ${error.message}`);
      buildInProgress = false;
      return;
    }
  }
  
  
  // ===== STANDARD BUILD/ENTERPRISE MODE (uses modal) =====
  // Show button with 0% progress circle
  if (btn) {
    btn.style.background = '#10b981';
    btn.innerHTML = '<div class="progress-circle" style="--progress-deg:0deg"><span>0%</span></div><span>Building...</span>';
  }
  
  const modal = document.getElementById('buildModal');
  modal.style.cssText = 'display: flex !important;';
  modal.classList.add('active');
  
  // Clear previous build steps
  const stepsContainer = document.getElementById('buildSteps');
  stepsContainer.innerHTML = '';
  
  // Show multi-step build progress with time estimates
  const statusText = document.getElementById('statusText');
  const totalTime = buildSteps.reduce((sum, step) => sum + step.duration, 0);
  const startTime = Date.now();
  
  // Start progress animation with accurate timing
  let currentStep = 0;
  let stepStartTime = Date.now();
  let currentSubStep = 0;
  
  // Add first main step
  addBuildStep(buildSteps[0].message, 'active');
  
  const progressTimer = setInterval(() => {
    const elapsed = Date.now() - startTime;
    const remaining = Math.max(0, Math.ceil((totalTime - elapsed) / 1000));
    const percentage = Math.min(95, Math.floor((elapsed / totalTime) * 100));
    const degrees = Math.floor((percentage / 100) * 360);
    
    // Update button percentage circle
    if (btn) {
      btn.innerHTML = `<div class="progress-circle" style="--progress-deg:${degrees}deg"><span>${percentage}%</span></div><span>Building...</span>`;
    }
    
    const stepElapsed = Date.now() - stepStartTime;
    const currentStepData = buildSteps[currentStep];
    
    // Add sub-steps gradually during current step
    if (currentStepData.steps && currentSubStep < currentStepData.steps.length) {
      const subStepInterval = currentStepData.duration / currentStepData.steps.length;
      if (stepElapsed >= subStepInterval * (currentSubStep + 1)) {
        addBuildStep(`  ‚Üí ${currentStepData.steps[currentSubStep]}`, 'success');
        currentSubStep++;
      }
    }
    
    // Check if we should move to next main step
    if (currentStep < buildSteps.length - 1 && stepElapsed >= currentStepData.duration) {
      updateLastStep('success');
      currentStep++;
      stepStartTime = Date.now();
      currentSubStep = 0;
      addBuildStep(buildSteps[currentStep].message, 'active');
    }
    
    // Update status text
    if (currentStep < buildSteps.length - 1) {
      statusText.textContent = `${buildSteps[currentStep].message} (${remaining}s remaining)`;
    } else if (remaining > 0) {
      statusText.textContent = `${buildSteps[buildSteps.length - 1].message} (${remaining}s remaining)`;
    } else {
      statusText.textContent = 'üé® Finishing up...';
    }
  }, 100);
  
  statusText.textContent = `${buildSteps[0].message} (${Math.ceil(totalTime / 1000)}s remaining)`;
  
  // Determine endpoint and request body based on mode
  let endpoint, requestBody;
  
  // Handle all 4 combinations
  if (planModeEnabled && enterpriseModeEnabled) {
    // BOTH modes: First plan, then user can trigger enterprise build
    endpoint = '/plan';
    requestBody = {
      instruction: idea,
      language: 'python',
      mode: 'plan'
    };
  } else if (enterpriseModeEnabled) {
    // Enterprise only: Direct enterprise build
    endpoint = '/enterprise-build';
    requestBody = {
      instruction: idea,
      language: 'python',
      enable_checkpoints: true,
      enable_testing: true,
      enable_security_scan: true,
      enable_multi_file: true
    };
  } else if (planModeEnabled) {
    // Plan only: Just planning
    endpoint = '/plan';
    requestBody = {
      instruction: idea,
      language: 'python',
      mode: 'plan'
    };
  } else {
    // Neither: Quick build
    endpoint = '/build';
    requestBody = {
      instruction: idea,
      language: 'python',
      mode: 'build'
    };
  }
  
  // Call REAL SuperAgent backend
  try {
    const response = await fetch(endpoint, {
      method: 'POST',
      headers: getAuthHeaders(),
      body: JSON.stringify(requestBody)
    });
    
    if (!response.ok) {
      const errorData = await response.json().catch(() => ({}));
      throw new Error(errorData.detail || `API error: ${response.status}`);
    }
    
    const data = await response.json();
    
    // Clear progress timer
    clearInterval(progressTimer);
    
    // Handle Enterprise Build response
    if (enterpriseModeEnabled && data.stages) {
      updateLastStep('success');
      addBuildStep('üöÄ Enterprise build complete!', 'success');
      
      // Display enterprise build results
      let enterpriseDisplay = `üè¢ **Enterprise Build Results**\n\n`;
      enterpriseDisplay += `‚è±Ô∏è Build Time: ${data.build_time}s\n`;
      enterpriseDisplay += `üìÅ Project: ${data.project_dir}\n\n`;
      enterpriseDisplay += `üìä **Build Stages Completed:**\n`;
      
      data.stages.forEach((stage, i) => {
        enterpriseDisplay += `${i + 1}. ${stage.stage}: ${stage.success ? '‚úÖ' : '‚ùå'}\n`;
      });
      
      enterpriseDisplay += `\nüìÑ **Files Created:** ${data.files_created.length}\n`;
      enterpriseDisplay += `üì¶ **Dependencies Installed:** ${data.dependencies_installed.length}\n`;
      enterpriseDisplay += `‚úÖ **Tests Passed:** ${data.tests_passed}\n`;
      enterpriseDisplay += `üîí **Security Issues:** ${data.security_issues.length}\n`;
      enterpriseDisplay += `‚≠ê **Code Quality Score:** ${data.verification_score}/100\n\n`;
      
      if (data.checkpoint_before) {
        enterpriseDisplay += `üîñ **Checkpoints:**\n`;
        enterpriseDisplay += `  - Before: ${data.checkpoint_before}\n`;
        enterpriseDisplay += `  - After: ${data.checkpoint_after}\n\n`;
      }
      
      if (data.production_files && data.production_files.length > 0) {
        enterpriseDisplay += `üè≠ **Production Files:**\n`;
        data.production_files.forEach(file => {
          enterpriseDisplay += `  - ${file}\n`;
        });
      }
      
      enterpriseDisplay += `\n‚ú® ${data.message}`;
      
      currentGeneratedCode = enterpriseDisplay;
      currentPrompt = idea;
      
      // Show in modal
      statusText.textContent = '‚úÖ Enterprise build ready!';
      if (btn) {
        btn.style.background = 'linear-gradient(135deg,#10B981,#34D399)';
        btn.innerHTML = '<span>‚úì</span><span>Enterprise Build Complete!</span>';
      }
      
      saveToHistory(idea, enterpriseDisplay);
      showNotification(`Enterprise build complete in ${data.build_time}s! ${data.files_created.length} files created with full production setup.`, 'success');
      
      // Auto-close modal after 3s and show results
      setTimeout(() => {
        modal.style.display = 'none';
        showGeneratedCode(enterpriseDisplay, idea);
      }, 3000);
      
      buildInProgress = false;
      return;
    }
    
    //  Handle Plan Mode response differently - SHOW IN MODAL
    if (data.mode === 'plan' && data.plan) {
      updateLastStep('success');
      addBuildStep('‚úÖ Intelligent plan created!', 'success');
      
      currentGeneratedCode = data.plan;
      currentPrompt = idea;
      
      // Update modal status
      statusText.textContent = '‚úÖ Smart Plan Ready - Review Questions & Suggestions';
      if (btn) {
        btn.style.background = 'linear-gradient(135deg,#9333EA,#7C3AED)';
        btn.innerHTML = '<span>üß†</span><span>Plan Complete!</span>';
      }
      
      const statusBadge = document.querySelector('.status-badge');
      if (statusBadge) {
        statusBadge.textContent = 'Planning Complete';
        statusBadge.style.background = 'rgba(147,51,234,.15)';
        statusBadge.style.color = '#9333EA';
      }
      
      // Display the full plan in the code preview area
      const codeContent = document.getElementById('codeContent');
      codeContent.innerHTML = '';
      codeContent.style.cssText = 'font-family:inherit;line-height:1.8;padding:2rem;color:#C0C7D4;overflow-y:auto;max-height:60vh;';
      
      // Convert markdown-style plan to HTML
      const planHTML = data.plan
        .replace(/\*\*(.*?)\*\*/g, '<strong style="color:#F4F6FB;">$1</strong>')
        .replace(/^### (.*?)$/gm, '<h3 style="color:#9333EA;margin:2rem 0 1rem 0;font-size:1.3rem;">$1</h3>')
        .replace(/^## (.*?)$/gm, '<h2 style="color:#10B981;margin:2rem 0 1rem 0;font-size:1.5rem;">$1</h2>')
        .replace(/^# (.*?)$/gm, '<h1 style="color:#F4F6FB;margin:2rem 0 1rem 0;font-size:1.8rem;">$1</h1>')
        .replace(/^- (.*?)$/gm, '<div style="margin:0.5rem 0 0.5rem 1.5rem;">‚Ä¢ $1</div>')
        .replace(/^\d+\. (.*?)$/gm, '<div style="margin:0.5rem 0 0.5rem 1.5rem;">$1</div>')
        .replace(/\n\n/g, '<br><br>');
      
      codeContent.innerHTML = planHTML;
      
      // Add suggested features section if available
      if (data.suggested_features && data.suggested_features.length > 0) {
        const featuresDiv = document.createElement('div');
        featuresDiv.style.cssText = 'margin-top:2rem;padding:1.5rem;background:rgba(147,51,234,.15);border-radius:0.75rem;border-left:4px solid #9333EA;';
        featuresDiv.innerHTML = `<h3 style="color:#9333EA;margin:0 0 1rem 0;">üí° ${data.suggested_features.length} Recommended Features</h3>`;
        data.suggested_features.forEach((feature, i) => {
          const featureEl = document.createElement('div');
          featureEl.style.cssText = 'color:#C0C7D4;margin:0.75rem 0;padding:0.75rem;background:rgba(0,0,0,.3);border-radius:0.5rem;';
          featureEl.innerHTML = `<strong style="color:#10B981;">${i + 1}.</strong> ${feature}`;
          featuresDiv.appendChild(featureEl);
        });
        codeContent.appendChild(featuresDiv);
      }
      
      // Add next step callout
      const nextStepDiv = document.createElement('div');
      nextStepDiv.style.cssText = 'margin-top:2rem;padding:1.5rem;background:rgba(16,185,129,.15);border-radius:0.75rem;text-align:center;border:2px solid #10B981;';
      nextStepDiv.innerHTML = `<strong style="color:#10B981;font-size:1.1rem;">‚úÖ ${data.next_step || 'Review the plan, then proceed to build!'}</strong>`;
      codeContent.appendChild(nextStepDiv);
      
      saveToHistory(idea, data.plan);
      showNotification('üß† Intelligent plan ready! Review the questions and suggestions below.', 'success');
      
      // KEEP MODAL OPEN - don't auto-close for plans
      buildInProgress = false;
      return;
    }
    
    // Show completion steps (Build Mode)
    updateLastStep('success');
    addBuildStep('üì¶ Installing packages...', 'active');
    if (data.packages_installed && data.packages_installed.length > 0) {
      for (const pkg of data.packages_installed) {
        await new Promise(r => setTimeout(r, 150));
        addBuildStep(`  ‚Üí Installed ${pkg}`, 'success');
      }
    }
    updateLastStep('success');
    
    addBuildStep('üìÅ Creating files...', 'active');
    if (data.files_created && data.files_created.length > 0) {
      for (const file of data.files_created) {
        await new Promise(r => setTimeout(r, 150));
        addBuildStep(`  ‚Üí Created ${file}`, 'success');
      }
    }
    updateLastStep('success');
    
    addBuildStep('‚úÖ Build complete!', 'success');
    
    // Display build results
    const buildMessage = `‚úÖ Complete app built successfully!\n\nüìÅ App: ${data.app_name}\nüìÑ Files: ${data.files_created.join(', ')}\nüì¶ Packages: ${data.packages_installed.join(', ') || 'None'}\nüöÄ Run: ${data.run_command}\n\n${data.message}`;
    
    // Save code preview
    currentGeneratedCode = data.code_preview || buildMessage;
    currentPrompt = idea;
    saveToHistory(idea, buildMessage);
    
    // Show 100% complete
    if (btn) {
      btn.innerHTML = '<div class="progress-circle" style="--progress-deg:360deg"><span>100%</span></div><span>Complete!</span>';
    }
    
    const statusBadge = document.querySelector('.status-badge');
    if (statusBadge) {
      statusBadge.textContent = 'Complete';
      statusBadge.style.background = 'rgba(52,211,153,.15)';
      statusBadge.style.color = '#34D399';
    }
    document.getElementById('statusText').textContent = data.success ? 'App Built!' : 'Build Complete';
    
    // Display code with live streaming animation
    const codeContent = document.getElementById('codeContent');
    const generatedCode = currentGeneratedCode;
    
    // Determine language for Prism
    const lang = selectedType === 'webapp' ? 'javascript' : 'python';
    
    // Animate code streaming character-by-character
    await animateCodeStreaming(codeContent, generatedCode, lang);
    
    // Save version after successful generation
    saveVersion();
    
    // Show live preview if preview URL exists
    if (data.preview_url) {
      showLivePreview(data.preview_url);
    } else {
      showPreview();
    }
    
    buildInProgress = false;
    
    // Reset button to original state after 2 seconds
    setTimeout(() => {
      if (btn) {
        btn.style.background = 'linear-gradient(135deg,#8A93A6,#C0C7D4)';
        btn.innerHTML = '<span>‚ñ∂</span><span>Start Building</span>';
      }
    }, 2000);
    
  } catch (error) {
    clearInterval(progressTimer);
    document.getElementById('statusText').innerHTML = '‚ö†Ô∏è Error generating code';
    const spinner = document.querySelector('.spinner');
    if (spinner) spinner.style.display = 'none';
    showNotification(error.message || 'Failed to generate code. Please try again.', 'error');
    buildInProgress = false;
    
    // Reset button
    if (btn) {
      btn.style.background = 'linear-gradient(135deg,#8A93A6,#C0C7D4)';
      btn.innerHTML = '<span>‚ñ∂</span><span>Start Building</span>';
    }
    
    setTimeout(() => closeModal(), 3000);
  }
}

// Poll real job status
async function pollJobStatus(jobId) {
  const maxAttempts = 120;
  let attempts = 0;
  
  const pollInterval = setInterval(async () => {
    if (attempts >= maxAttempts) {
      clearInterval(pollInterval);
      document.getElementById('statusText').textContent = '‚è±Ô∏è Build timeout';
      document.querySelector('.spinner').style.display = 'none';
      showNotification('Build took too long. Please try again with a simpler project.', 'warning');
      buildInProgress = false;
      setTimeout(() => closeModal(), 3000);
      return;
    }
    
    try {
      const response = await fetch(`/health`, {
        headers: { 'Content-Type': 'application/json' }
      });
      
      if (!response.ok) throw new Error('Status check failed');
      
      const data = await response.json();
      const progress = Math.min(data.progress || 0, 1);
      
      // Update status based on progress
      if (progress < 0.2) {
        document.getElementById('statusText').textContent = 'üìã Planning architecture...';
      } else if (progress < 0.4) {
        document.getElementById('statusText').textContent = 'üíª Generating code...';
        streamRealCode(data);
      } else if (progress < 0.6) {
        document.getElementById('statusText').textContent = 'üîç 2 Supervisors verifying...';
      } else if (progress < 0.8) {
        document.getElementById('statusText').textContent = 'üëë Supreme Agent review...';
      } else {
        document.getElementById('statusText').textContent = 'üß™ Running tests...';
      }
      
      if (data.status === 'completed') {
        clearInterval(pollInterval);
        showRealResults(data.result);
        showNotification('Build completed successfully!', 'success');
      } else if (data.status === 'failed') {
        clearInterval(pollInterval);
        document.getElementById('statusText').innerHTML = '‚ùå Build failed';
        document.querySelector('.spinner').style.display = 'none';
        showNotification('Build failed: ' + (data.error || 'Unknown error'), 'error');
        buildInProgress = false;
        setTimeout(() => closeModal(), 3000);
      }
      
    } catch (error) {
      console.error('Poll error:', error);
    }
    
    attempts++;
  }, 5000);
}

function streamRealCode(data) {
  // Show real code from backend
  const codeContent = document.getElementById('codeContent');
  const fileNameEl = document.getElementById('currentFileName');
  
  if (data.result && data.result.generated_files) {
    const firstFile = data.result.generated_files[0];
    if (firstFile) {
      fileNameEl.textContent = firstFile;
      // In real implementation, would fetch file content
    }
  }
}

function showRealResults(result) {
  document.querySelector('.spinner').style.display = 'none';
  document.getElementById('statusText').className = 'status-complete';
  document.getElementById('statusText').textContent = '‚úÖ Build complete!';
  
  if (result.generated_files) {
    const files = result.generated_files;
    const codeContent = document.getElementById('codeContent');
    codeContent.innerHTML = `
      <div style="color:#34D399;padding:2rem;text-align:center;">
        <h3>‚úÖ Project Built Successfully!</h3>
        <p style="margin-top:1rem;color:#9CA3AF;">Generated ${files.length} files</p>
        <div style="margin-top:1rem;text-align:left;max-width:400px;margin-left:auto;margin-right:auto;">
          ${files.map(f => `<div style="padding:0.5rem;color:#E3E3E8;">üìÑ ${f}</div>`).join('')}
        </div>
      </div>
    `;
  }
  
  // Show preview if available
  showPreview();
  
  buildInProgress = false;
}

// REMOVED: Demo mode - Production only!
// This system uses the REAL SuperAgent backend
// No simulations, no fake builds - 100% production code generation

function streamCode(filename) {
  const codeContent = document.getElementById('codeContent');
  const fileNameEl = document.getElementById('currentFileName');
  
  codeContent.innerHTML = '';
  fileNameEl.textContent = filename;
  
  const code = codeFiles[filename];
  const lines = code.split('\n');
  let lineIndex = 0;
  
  const interval = setInterval(() => {
    if (lineIndex < lines.length) {
      const lineDiv = document.createElement('div');
      lineDiv.className = 'code-line';
      
      const lineNum = document.createElement('div');
      lineNum.className = 'line-num';
      lineNum.textContent = lineIndex + 1;
      
      const lineCode = document.createElement('div');
      lineCode.className = 'line-code';
      lineCode.textContent = lines[lineIndex];
      
      if (lineIndex % 3 === 0) {
        const cursor = document.createElement('span');
        cursor.className = 'cursor';
        lineCode.appendChild(cursor);
      }
      
      lineDiv.appendChild(lineNum);
      lineDiv.appendChild(lineCode);
      codeContent.appendChild(lineDiv);
      codeContent.scrollTop = codeContent.scrollHeight;
      
      lineIndex++;
    } else {
      clearInterval(interval);
    }
  }, 80);
}

function showPreview() {
  const previewContent = document.getElementById('previewContent');
  
  // Auto-run live preview for web apps
  if (selectedType === 'webapp') {
    setTimeout(() => {
      runLivePreview();
    }, 300);
  } else {
    previewContent.innerHTML = '<div style="color:#34D399;padding:2rem;text-align:center;"><h3>‚úÖ Preview Ready!</h3><p style="color:#9CA3AF;">Your generated code is ready to use</p></div>';
  }
}

function showLivePreview(previewUrl) {
  // Show the preview panel
  const previewPanel = document.querySelector('.preview-panel');
  if (previewPanel) {
    previewPanel.classList.add('active');
  }
  
  // Load the preview in iframe
  const previewContent = document.getElementById('previewContent');
  previewContent.innerHTML = `<iframe class="preview-iframe" src="${previewUrl}" title="App Preview"></iframe>`;
  
  showNotification('üéâ Live preview loaded!', 'success');
}

function closeModal() {
  const modal = document.getElementById('buildModal');
  modal.classList.remove('active');
  modal.style.cssText = 'display: none !important;';
  buildInProgress = false;
  isEditMode = false; // Reset edit mode
  
  // Reset button
  const btn = document.querySelector('.start-btn');
  if (btn) {
    btn.style.background = 'linear-gradient(135deg,#8A93A6,#C0C7D4)';
    btn.innerHTML = '<span>‚ñ∂</span><span>Start Building</span>';
  }
}

// Close modal on escape and other keyboard shortcuts
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') closeModal();
  
  // Ctrl/Cmd + Enter to start building
  if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
    const ideaInput = document.getElementById('ideaInput');
    if (ideaInput.value.trim() && !buildInProgress) {
      startBuild({ target: document.querySelector('.start-btn') });
    }
  }
  
  // Ctrl/Cmd + C to copy code (when modal is open)
  if ((e.ctrlKey || e.metaKey) && e.key === 'c' && document.getElementById('buildModal').classList.contains('active')) {
    if (currentGeneratedCode && !window.getSelection().toString()) {
      e.preventDefault();
      copyCode();
    }
  }
});

// Copy code to clipboard
function copyCode() {
  if (!currentGeneratedCode) {
    showNotification('No code to copy yet', 'warning');
    return;
  }
  
  navigator.clipboard.writeText(currentGeneratedCode).then(() => {
    showNotification('‚úÖ Code copied to clipboard!', 'success');
  }).catch(err => {
    showNotification('Failed to copy code', 'error');
  });
}

// Download code as file
function downloadCode() {
  if (!currentGeneratedCode) {
    showNotification('No code to download yet', 'warning');
    return;
  }
  
  const fileName = document.getElementById('currentFileName').textContent || 'code.py';
  const blob = new Blob([currentGeneratedCode], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = fileName;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  showNotification(`‚úÖ Downloaded ${fileName}`, 'success');
}

// Regenerate code with same prompt
async function regenerateCode() {
  if (!currentPrompt) {
    showNotification('No prompt to regenerate from', 'warning');
    return;
  }
  
  document.getElementById('ideaInput').value = currentPrompt;
  closeModal();
  
  setTimeout(() => {
    startBuild({ target: document.querySelector('.start-btn') });
  }, 300);
}

// Save to generation history
function saveToHistory(prompt, code) {
  const entry = {
    id: Date.now(),
    prompt: prompt,
    code: code,
    timestamp: new Date().toISOString(),
    language: selectedType
  };
  
  generationHistory.unshift(entry);
  
  // Keep only last 10
  if (generationHistory.length > 10) {
    generationHistory = generationHistory.slice(0, 10);
  }
  
  localStorage.setItem('superagent_history', JSON.stringify(generationHistory));
}

// View generation history
function viewHistory() {
  if (generationHistory.length === 0) {
    showNotification('No generation history yet', 'info');
    return;
  }
  
  const historyHtml = generationHistory.map((entry, i) => `
    <div style="padding:1rem;border-bottom:1px solid #2E3244;cursor:pointer;" onclick="loadHistoryItem(${i})">
      <div style="color:#C0C7D4;font-weight:600;">${entry.prompt.substring(0, 60)}...</div>
      <div style="color:#5A5F6E;font-size:0.8rem;margin-top:0.25rem;">${new Date(entry.timestamp).toLocaleString()}</div>
    </div>
  `).join('');
  
  const codeContent = document.getElementById('codeContent');
  codeContent.innerHTML = `
    <div style="padding:1rem;">
      <div style="color:#C0C7D4;font-size:1.1rem;font-weight:600;margin-bottom:1rem;">üìö Generation History</div>
      ${historyHtml}
    </div>
  `;
  
  const modal = document.getElementById('buildModal');
  modal.style.cssText = 'display: flex !important;';
  modal.classList.add('active');
}

function loadHistoryItem(index) {
  const entry = generationHistory[index];
  currentGeneratedCode = entry.code;
  currentPrompt = entry.prompt;
  selectedType = entry.language || 'webapp';
  
  const codeContent = document.getElementById('codeContent');
  const lang = selectedType === 'webapp' ? 'javascript' : 'python';
  
  codeContent.innerHTML = `
    <pre style="margin:0;height:100%;overflow-y:auto;"><code class="language-${lang}" style="display:block;white-space:pre;line-height:1.65;">${escapeHtml(entry.code)}</code></pre>
  `;
  
  if (typeof Prism !== 'undefined') {
    Prism.highlightAll();
  }
  
  showNotification('Loaded from history', 'success');
}

// Handle file upload
function handleFileUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const ideaInput = document.getElementById('ideaInput');
  
  if (file.type.startsWith('image/')) {
    // Image file
    showNotification(`üì∏ Image attached: ${file.name}`, 'success');
    if (ideaInput.value.trim()) {
      ideaInput.value += `\n\n[Image attached: ${file.name}]`;
    } else {
      ideaInput.value = `Generate code based on this image: ${file.name}`;
    }
  } else {
    // Text/PDF file
    const reader = new FileReader();
    reader.onload = (e) => {
      const content = e.target.result;
      if (ideaInput.value.trim()) {
        ideaInput.value += `\n\n--- File content (${file.name}) ---\n${content.substring(0, 500)}`;
      } else {
        ideaInput.value = `Analyze this file:\n\n${content.substring(0, 500)}`;
      }
      showNotification(`üìÑ File loaded: ${file.name}`, 'success');
    };
    reader.readAsText(file);
  }
  
  // Reset input
  event.target.value = '';
}

// Explain code using AI
async function explainCode() {
  if (!currentGeneratedCode) {
    showNotification('No code to explain yet', 'warning');
    return;
  }
  
  const previewContent = document.getElementById('previewContent');
  previewContent.innerHTML = '<div style="padding:2rem;color:#8A93A6;text-align:center;"><div class="spinner" style="display:inline-block;margin-bottom:1rem;"></div><div>Generating explanation...</div></div>';
  
  try {
    const response = await fetch('/generate', {
      method: 'POST',
      headers: getAuthHeaders(),
      body: JSON.stringify({
        instruction: `Explain this code in simple terms, line by line:\n\n${currentGeneratedCode}`,
        language: 'text'
      })
    });
    
    if (!response.ok) throw new Error('Failed to generate explanation');
    
    const data = await response.json();
    const explanation = data.code || 'Explanation generated';
    
    previewContent.innerHTML = `
      <div style="padding:2rem;color:#D0D4E0;overflow-y:auto;height:100%;">
        <h3 style="color:#C0C7D4;margin-bottom:1rem;">üí° Code Explanation</h3>
        <div style="line-height:1.8;white-space:pre-wrap;">${explanation}</div>
      </div>
    `;
    
    showNotification('‚úÖ Explanation generated!', 'success');
  } catch (error) {
    previewContent.innerHTML = '<div style="color:#EF4444;padding:2rem;text-align:center;">Failed to generate explanation</div>';
    showNotification(error.message || 'Failed to explain code', 'error');
  }
}

// Share code - generate shareable link
function shareCode() {
  if (!currentGeneratedCode) {
    showNotification('No code to share yet', 'warning');
    return;
  }
  
  // Create a data URL with the code
  const codeData = {
    code: currentGeneratedCode,
    prompt: currentPrompt,
    language: selectedType,
    timestamp: new Date().toISOString()
  };
  
  const encoded = btoa(JSON.stringify(codeData));
  const shareUrl = `${window.location.origin}${window.location.pathname}?shared=${encoded}`;
  
  navigator.clipboard.writeText(shareUrl).then(() => {
    showNotification('üîó Share link copied to clipboard!', 'success');
    
    // Show share dialog
    const previewContent = document.getElementById('previewContent');
    previewContent.innerHTML = `
      <div style="padding:2rem;color:#D0D4E0;">
        <h3 style="color:#C0C7D4;margin-bottom:1rem;">üîó Share Code</h3>
        <p style="margin-bottom:1rem;color:#8A93A6;">Share link copied! Anyone with this link can view your code:</p>
        <input type="text" value="${shareUrl}" readonly 
          style="width:100%;padding:0.75rem;background:#0D0F13;border:1px solid #2E3244;
          border-radius:0.5rem;color:#C0C7D4;font-size:0.875rem;font-family:monospace;"
          onclick="this.select()">
        <p style="margin-top:1rem;color:#5A5F6E;font-size:0.875rem;">
          üí° Tip: The code is embedded in the URL, so it works without a server!
        </p>
      </div>
    `;
  }).catch(err => {
    showNotification('Failed to copy share link', 'error');
  });
}

// Make code editable - toggle between edit and view modes
let isEditMode = false;

function makeCodeEditable() {
  const codeContent = document.getElementById('codeContent');
  
  if (!currentGeneratedCode) {
    showNotification('No code to edit yet', 'warning');
    return;
  }
  
  if (!isEditMode) {
    // Switch to edit mode - replace with textarea
    codeContent.innerHTML = `
      <textarea id="codeEditor" 
        style="width:100%;height:100%;background:#0D0F13;color:#D0D4E0;border:none;
        padding:1.5rem;font-family:'Monaco','Menlo','Ubuntu Mono',monospace;
        font-size:0.875rem;line-height:1.65;resize:none;outline:none;"
        spellcheck="false">${escapeHtml(currentGeneratedCode)}</textarea>
    `;
    
    // Auto-update currentGeneratedCode as user types
    const editor = document.getElementById('codeEditor');
    editor.addEventListener('input', (e) => {
      currentGeneratedCode = e.target.value;
    });
    
    isEditMode = true;
    showNotification('‚úèÔ∏è Edit mode enabled - changes auto-save', 'success');
  } else {
    // Switch back to view mode with syntax highlighting
    const lang = selectedType === 'webapp' ? 'javascript' : 'python';
    
    codeContent.innerHTML = `
      <pre style="margin:0;height:100%;overflow-y:auto;"><code class="language-${lang}" style="display:block;white-space:pre;line-height:1.65;">${escapeHtml(currentGeneratedCode)}</code></pre>
    `;
    
    if (typeof Prism !== 'undefined') {
      Prism.highlightAll();
    }
    
    isEditMode = false;
    showNotification('üëÅÔ∏è View mode - syntax highlighting restored', 'success');
  }
}

// Live preview - run code in iframe
function runLivePreview() {
  if (!currentGeneratedCode) {
    showNotification('No code to preview yet', 'warning');
    return;
  }
  
  const previewContent = document.getElementById('previewContent');
  
  // Only works for web apps (HTML/CSS/JS)
  if (selectedType !== 'webapp') {
    previewContent.innerHTML = `
      <div style="padding:2rem;color:#8A93A6;text-align:center;">
        <h3 style="color:#C0C7D4;margin-bottom:1rem;">‚ö†Ô∏è Live Preview Not Available</h3>
        <p>Live preview only works for Web Apps (HTML/CSS/JavaScript).</p>
        <p style="margin-top:1rem;color:#5A5F6E;">For other project types, copy the code and run it locally.</p>
      </div>
    `;
    return;
  }
  
  // Create sandboxed iframe
  previewContent.innerHTML = `
    <iframe id="livePreviewFrame" 
      style="width:100%;height:100%;border:none;background:white;" 
      sandbox="allow-scripts allow-same-origin">
    </iframe>
  `;
  
  const iframe = document.getElementById('livePreviewFrame');
  const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
  
  // Write code to iframe
  iframeDoc.open();
  iframeDoc.write(currentGeneratedCode);
  iframeDoc.close();
  
  showNotification('üöÄ Live preview loaded!', 'success');
}

// Deploy to Replit
function deployToReplit() {
  if (!currentGeneratedCode) {
    showNotification('No code to deploy yet', 'warning');
    return;
  }
  
  const previewContent = document.getElementById('previewContent');
  
  // Show deployment instructions
  previewContent.innerHTML = `
    <div style="padding:2rem;color:#D0D4E0;overflow-y:auto;height:100%;">
      <h3 style="color:#C0C7D4;margin-bottom:1rem;">üöÄ Deploy to Replit</h3>
      
      <div style="background:#1A1D29;border:1px solid #2E3244;border-radius:0.5rem;padding:1.5rem;margin-bottom:1.5rem;">
        <h4 style="color:#8A93A6;font-size:0.875rem;margin-bottom:1rem;">STEP 1: Create a New Repl</h4>
        <button onclick="window.open('https://replit.com/new', '_blank')" 
          style="width:100%;padding:0.75rem;background:linear-gradient(135deg,#8A93A6,#C0C7D4);
          border:none;border-radius:0.5rem;color:#0D0F13;font-weight:600;cursor:pointer;">
          Open Replit Editor
        </button>
      </div>
      
      <div style="background:#1A1D29;border:1px solid #2E3244;border-radius:0.5rem;padding:1.5rem;margin-bottom:1.5rem;">
        <h4 style="color:#8A93A6;font-size:0.875rem;margin-bottom:1rem;">STEP 2: Copy Your Code</h4>
        <p style="color:#6B7280;font-size:0.875rem;margin-bottom:0.75rem;">
          Your code has been copied to clipboard! Paste it into your Repl.
        </p>
        <button onclick="copyCodeToClipboard()" 
          style="width:100%;padding:0.75rem;background:#2E3244;border:1px solid #3E4254;
          border-radius:0.5rem;color:#C0C7D4;font-weight:600;cursor:pointer;">
          üìã Copy Code Again
        </button>
      </div>
      
      <div style="background:#1A1D29;border:1px solid #2E3244;border-radius:0.5rem;padding:1.5rem;">
        <h4 style="color:#8A93A6;font-size:0.875rem;margin-bottom:1rem;">STEP 3: Publish Your Repl</h4>
        <ol style="color:#6B7280;font-size:0.875rem;line-height:1.8;margin-left:1.5rem;">
          <li>In the Replit editor, click the "Deploy" button (top right)</li>
          <li>Choose "Autoscale" for web apps or "Reserved VM" for always-on apps</li>
          <li>Click "Deploy" to get your live URL</li>
          <li>Share your app with the world! üéâ</li>
        </ol>
      </div>
      
      <div style="margin-top:1.5rem;padding:1rem;background:#0D0F13;border:1px solid #2E3244;border-radius:0.5rem;">
        <p style="color:#5A5F6E;font-size:0.875rem;">
          üí° <strong>Tip:</strong> Replit deployments are free to start and scale automatically with traffic.
        </p>
      </div>
    </div>
  `;
  
  // Auto-copy code to clipboard
  copyCodeToClipboard();
  showNotification('üöÄ Ready to deploy! Follow the steps in the preview panel.', 'success');
}

// ========== ALL 15 NEW FEATURES ==========

// Global state for new features
let versionHistory = [];
let currentVersion = -1;
let deviceSize = 'desktop';
let codeTemplates = {
  'todo-app': {name: 'Todo List App', code: 'Build a todo list app with add, delete, and mark complete features', type: 'webapp'},
  'portfolio': {name: 'Portfolio Website', code: 'Create a professional portfolio website with sections for about, projects, and contact', type: 'webapp'},
  'api-rest': {name: 'REST API', code: 'Build a REST API with CRUD operations for a blog (posts and comments)', type: 'api'},
  'chatbot': {name: 'Chatbot', code: 'Create a simple chatbot with natural language processing', type: 'tool'},
  'scraper': {name: 'Web Scraper', code: 'Build a web scraper that extracts data from websites and saves to JSON', type: 'automation'}
};
let currentTheme = 'default';
let themes = {
  'default': {primary: '#8A93A6', secondary: '#C0C7D4', bg: '#0D0F13'},
  'purple': {primary: '#9333EA', secondary: '#A855F7', bg: '#1F0A2E'},
  'gray': {primary: '#8A93A6', secondary: '#C0C7D4', bg: '#1A1D29'},
  'green': {primary: '#10B981', secondary: '#34D399', bg: '#064E3B'}
};

// 1. TEMPLATES LIBRARY
function openTemplatesModal() {
  const modal = document.createElement('div');
  modal.id = 'templatesModal';
  modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:2000;display:flex;align-items:center;justify-content:center;';
  
  modal.innerHTML = `
    <div style="background:#1C1F2B;padding:2rem;border-radius:1rem;max-width:800px;width:90%;max-height:80vh;overflow-y:auto;">
      <h2 style="color:#C0C7D4;margin-bottom:1.5rem;">üìö Code Templates</h2>
      <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:1rem;">
        ${Object.entries(codeTemplates).map(([key, t]) => `
          <div onclick="useTemplate('${key}')" style="background:#252938;padding:1.5rem;border-radius:0.5rem;cursor:pointer;border:1px solid #2E3244;transition:all 0.2s;" onmouseover="this.style.borderColor='#8A93A6'" onmouseout="this.style.borderColor='#2E3244'">
            <div style="font-size:1.5rem;margin-bottom:0.5rem;">${t.type === 'webapp' ? 'üåê' : t.type === 'api' ? 'üîå' : 'üõ†Ô∏è'}</div>
            <div style="color:#C0C7D4;font-weight:600;margin-bottom:0.25rem;">${t.name}</div>
            <div style="color:#8A93A6;font-size:0.8rem;">${t.type}</div>
          </div>
        `).join('')}
      </div>
      <button onclick="document.getElementById('templatesModal').remove()" style="margin-top:1.5rem;padding:0.75rem 1.5rem;background:#8A93A6;color:#0D0F13;border:none;border-radius:0.5rem;cursor:pointer;font-weight:600;">Close</button>
    </div>
  `;
  
  document.body.appendChild(modal);
}

function useTemplate(key) {
  const template = codeTemplates[key];
  document.getElementById('ideaInput').value = template.code;
  document.querySelector(`[data-type="${template.type}"]`).click();
  document.getElementById('templatesModal').remove();
  showNotification(`‚ú® Template "${template.name}" loaded!`, 'success');
}

// 2. VERSION CONTROL
function saveVersion() {
  if (currentGeneratedCode) {
    versionHistory.push({code: currentGeneratedCode, timestamp: Date.now()});
    currentVersion = versionHistory.length - 1;
  }
}

function undoVersion() {
  if (currentVersion > 0) {
    currentVersion--;
    currentGeneratedCode = versionHistory[currentVersion].code;
    updateCodeDisplay();
    showNotification('‚è™ Undid to previous version', 'success');
  } else {
    showNotification('No previous version', 'warning');
  }
}

function redoVersion() {
  if (currentVersion < versionHistory.length - 1) {
    currentVersion++;
    currentGeneratedCode = versionHistory[currentVersion].code;
    updateCodeDisplay();
    showNotification('‚è© Redid to next version', 'success');
  } else {
    showNotification('No next version', 'warning');
  }
}

function updateCodeDisplay() {
  const codeContent = document.getElementById('codeContent');
  const lang = selectedType === 'webapp' ? 'javascript' : 'python';
  codeContent.innerHTML = `<pre style="margin:0;height:100%;overflow-y:auto;"><code class="language-${lang}" style="display:block;white-space:pre;line-height:1.65;">${escapeHtml(currentGeneratedCode)}</code></pre>`;
  if (typeof Prism !== 'undefined') Prism.highlightAll();
}

// 3. DEVICE PREVIEW
function setDeviceSize(size) {
  deviceSize = size;
  const preview = document.getElementById('previewContent');
  const iframe = preview.querySelector('iframe');
  
  if (iframe) {
    const sizes = {desktop: '100%', tablet: '768px', mobile: '375px'};
    iframe.style.width = sizes[size];
    iframe.style.margin = size !== 'desktop' ? '0 auto' : '0';
    showNotification(`üì± Preview set to ${size}`, 'info');
  }
}

// 4. CODE QUALITY SCORE
async function showQualityScore() {
  if (!currentGeneratedCode) {
    showNotification('No code to analyze', 'warning');
    return;
  }
  
  const preview = document.getElementById('previewContent');
  preview.innerHTML = '<div style="padding:2rem;text-align:center;color:#8A93A6;"><div class="spinner" style="display:inline-block;"></div><div>Analyzing code quality...</div></div>';
  
  try {
    const response = await fetch('/generate', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        instruction: `Analyze this code and rate it 0-100 on: Security, Performance, Maintainability, Best Practices. Format: "Security: 85/100\\nPerformance: 90/100..." then give 3 improvement suggestions:\\n\\n${currentGeneratedCode}`,
        language: 'text'
      })
    });
    
    const data = await response.json();
    const analysis = data.code || 'Analysis complete';
    
    preview.innerHTML = `
      <div style="padding:2rem;color:#D0D4E0;">
        <h3 style="color:#C0C7D4;margin-bottom:1rem;">üìä Code Quality Analysis</h3>
        <pre style="background:#0D0F13;padding:1rem;border-radius:0.5rem;line-height:1.8;color:#8A93A6;white-space:pre-wrap;">${analysis}</pre>
      </div>
    `;
    showNotification('‚úÖ Quality analysis complete!', 'success');
  } catch (error) {
    preview.innerHTML = '<div style="padding:2rem;color:#EF4444;">Analysis failed</div>';
  }
}

// 5. AI CHAT ASSISTANT
let chatHistory = [];
function toggleAIChat() {
  const preview = document.getElementById('previewContent');
  
  preview.innerHTML = `
    <div style="padding:1rem;height:100%;display:flex;flex-direction:column;">
      <h3 style="color:#C0C7D4;margin-bottom:1rem;">üí¨ AI Chat Assistant</h3>
      <div id="chatMessages" style="flex:1;overflow-y:auto;background:#0D0F13;padding:1rem;border-radius:0.5rem;margin-bottom:1rem;">
        ${chatHistory.map(m => `<div style="margin-bottom:1rem;color:${m.role === 'user' ? '#C0C7D4' : '#8A93A6'}"><strong>${m.role}:</strong> ${m.content}</div>`).join('') || '<div style="color:#5A5F6E;">Ask me anything about your code...</div>'}
      </div>
      <div style="display:flex;gap:0.5rem;">
        <input type="text" id="chatInput" placeholder="Ask about your code..." style="flex:1;padding:0.75rem;background:#0D0F13;border:1px solid #2E3244;border-radius:0.5rem;color:#C0C7D4;" onkeypress="if(event.key==='Enter')sendChatMessage()">
        <button onclick="sendChatMessage()" style="padding:0.75rem 1.5rem;background:#8A93A6;color:#0D0F13;border:none;border-radius:0.5rem;cursor:pointer;font-weight:600;">Send</button>
      </div>
    </div>
  `;
}

async function sendChatMessage() {
  const input = document.getElementById('chatInput');
  const message = input.value.trim();
  if (!message) return;
  
  chatHistory.push({role: 'user', content: message});
  input.value = '';
  
  const response = await fetch('/generate', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      instruction: `Context: User is working on this code:\\n${currentGeneratedCode}\\n\\nUser question: ${message}\\n\\nProvide a helpful answer.`,
      language: 'text'
    })
  });
  
  const data = await response.json();
  chatHistory.push({role: 'assistant', content: data.code || 'I can help with that!'});
  toggleAIChat();
}

// 6. CODE SEARCH
function openCodeSearch() {
  const search = prompt('üîç Search in code:');
  if (!search) return;
  
  const code = currentGeneratedCode;
  const matches = (code.match(new RegExp(search, 'gi')) || []).length;
  
  if (matches > 0) {
    showNotification(`Found ${matches} match(es) for "${search}"`, 'success');
  } else {
    showNotification(`No matches found for "${search}"`, 'warning');
  }
}

// 7. EXPORT TO GITHUB
function exportToGitHub() {
  const preview = document.getElementById('previewContent');
  preview.innerHTML = `
    <div style="padding:2rem;color:#D0D4E0;">
      <h3 style="color:#C0C7D4;margin-bottom:1rem;">üìä Export to GitHub</h3>
      <p style="margin-bottom:1rem;color:#8A93A6;">To export your code to GitHub:</p>
      <ol style="line-height:2;color:#8A93A6;margin-left:1.5rem;">
        <li>Create a new repository on <a href="https://github.com/new" target="_blank" style="color:#C0C7D4;">GitHub.com</a></li>
        <li>Copy your code (already in clipboard)</li>
        <li>Create files in your repo and paste the code</li>
        <li>Commit and push!</li>
      </ol>
      <button onclick="copyCode()" style="margin-top:1rem;padding:0.75rem 1.5rem;background:#8A93A6;color:#0D0F13;border:none;border-radius:0.5rem;cursor:pointer;font-weight:600;">Copy Code</button>
    </div>
  `;
  copyCode();
  showNotification('üìã Code copied! Ready for GitHub', 'success');
}

// 8. THEME CUSTOMIZER
function openThemeCustomizer() {
  const modal = document.createElement('div');
  modal.id = 'themeModal';
  modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:2000;display:flex;align-items:center;justify-content:center;';
  
  modal.innerHTML = `
    <div style="background:#1C1F2B;padding:2rem;border-radius:1rem;max-width:600px;width:90%;">
      <h2 style="color:#C0C7D4;margin-bottom:1.5rem;">üé® Theme Customizer</h2>
      <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:1rem;">
        ${Object.entries(themes).map(([key, t]) => `
          <div onclick="applyTheme('${key}')" style="background:${t.bg};padding:1.5rem;border-radius:0.5rem;cursor:pointer;border:2px solid ${currentTheme === key ? t.primary : 'transparent'};">
            <div style="width:100%;height:60px;background:linear-gradient(135deg,${t.primary},${t.secondary});border-radius:0.5rem;margin-bottom:0.5rem;"></div>
            <div style="color:${t.secondary};font-weight:600;text-transform:capitalize;">${key}</div>
          </div>
        `).join('')}
      </div>
      <button onclick="document.getElementById('themeModal').remove()" style="margin-top:1.5rem;padding:0.75rem 1.5rem;background:#8A93A6;color:#0D0F13;border:none;border-radius:0.5rem;cursor:pointer;font-weight:600;width:100%;">Close</button>
    </div>
  `;
  
  document.body.appendChild(modal);
}

function applyTheme(themeName) {
  currentTheme = themeName;
  const theme = themes[themeName];
  localStorage.setItem('theme', themeName);
  showNotification(`üé® ${themeName} theme applied!`, 'success');
  document.getElementById('themeModal').remove();
  location.reload();
}

// ========== TIER 1 FEATURE FUNCTIONS ==========

// 1. Hallucination Fixer - Verify Code
async function verifyCode() {
  if (!currentGeneratedCode) {
    showNotification('No code to verify', 'warning');
    return;
  }
  
  const preview = document.getElementById('previewContent');
  preview.innerHTML = '<div style="padding:2rem;text-align:center;color:#8A93A6;"><div class="spinner"></div> Verifying code with 4-layer system...</div>';
  
  try {
    const response = await fetch('/verify-code', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        code: currentGeneratedCode,
        language: selectedType === 'webapp' ? 'javascript' : 'python',
        context: currentPrompt
      })
    });
    
    const data = await response.json();
    const v = data.verification;
    
    preview.innerHTML = `
      <div style="padding:2rem;color:#D0D4E0;">
        <h3 style="color:#C0C7D4;margin-bottom:1rem;">üõ°Ô∏è Code Verification Report</h3>
        <div style="background:#0D0F13;padding:1rem;border-radius:0.5rem;margin-bottom:1rem;">
          <div style="font-size:2rem;margin-bottom:0.5rem;">${v.verified ? '‚úÖ' : '‚ö†Ô∏è'}</div>
          <div style="font-size:1.2rem;color:${v.verified ? '#34D399' : '#F59E0B'};">
            Overall Score: ${v.score}/100
          </div>
        </div>
        <div style="background:#1A1D29;padding:1rem;border-radius:0.5rem;margin-bottom:1rem;">
          <h4 style="color:#8A93A6;margin-bottom:0.5rem;">Layer Scores:</h4>
          <div>Syntax: ${v.layer_scores.syntax}/100</div>
          <div>Logic: ${v.layer_scores.logic}/100</div>
          <div>Consistency: ${v.layer_scores.consistency}/100</div>
          <div>Grounding: ${v.layer_scores.grounding}/100</div>
        </div>
        ${v.issues.length > 0 ? `
          <div style="background:#1A1D29;padding:1rem;border-radius:0.5rem;">
            <h4 style="color:#8A93A6;margin-bottom:0.5rem;">Issues Found:</h4>
            ${v.issues.map(issue => `<div style="color:#EF4444;margin-bottom:0.25rem;">‚Ä¢ ${issue}</div>`).join('')}
          </div>
        ` : '<div style="color:#34D399;">‚úì No issues detected!</div>'}
      </div>
    `;
    showNotification(`Verification complete: ${v.score}/100`, v.verified ? 'success' : 'warning');
  } catch (error) {
    preview.innerHTML = `<div style="padding:2rem;color:#EF4444;">Error: ${error.message}</div>`;
  }
}

// 2. Documentation Generator
async function generateDocs() {
  if (!currentGeneratedCode) {
    showNotification('No code to document', 'warning');
    return;
  }
  
  const preview = document.getElementById('previewContent');
  preview.innerHTML = '<div style="padding:2rem;text-align:center;color:#8A93A6;"><div class="spinner"></div> Generating documentation...</div>';
  
  try {
    const response = await fetch('/generate-docs', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        code: currentGeneratedCode,
        language: selectedType === 'webapp' ? 'javascript' : 'python',
        project_name: 'My Project'
      })
    });
    
    const data = await response.json();
    
    preview.innerHTML = `
      <div style="padding:2rem;color:#D0D4E0;">
        <h3 style="color:#C0C7D4;margin-bottom:1rem;">üìö Generated Documentation</h3>
        <div style="background:#0D0F13;padding:1rem;border-radius:0.5rem;margin-bottom:1rem;">
          <h4 style="color:#8A93A6;margin-bottom:0.5rem;">README.md</h4>
          <pre style="white-space:pre-wrap;color:#8A93A6;font-size:0.875rem;">${data.readme}</pre>
        </div>
        <button onclick="copyToClipboard(\`${data.readme.replace(/`/g, '\\`')}\`)" style="padding:0.75rem 1.5rem;background:#8A93A6;color:#0D0F13;border:none;border-radius:0.5rem;cursor:pointer;font-weight:600;">Copy README</button>
      </div>
    `;
    showNotification('Documentation generated!', 'success');
  } catch (error) {
    preview.innerHTML = `<div style="padding:2rem;color:#EF4444;">Error: ${error.message}</div>`;
  }
}

// 3. Test Generator
async function generateTests() {
  if (!currentGeneratedCode) {
    showNotification('No code to test', 'warning');
    return;
  }
  
  const preview = document.getElementById('previewContent');
  preview.innerHTML = '<div style="padding:2rem;text-align:center;color:#8A93A6;"><div class="spinner"></div> Generating tests...</div>';
  
  try {
    const response = await fetch('/generate-tests', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        code: currentGeneratedCode,
        language: selectedType === 'webapp' ? 'javascript' : 'python'
      })
    });
    
    const data = await response.json();
    
    preview.innerHTML = `
      <div style="padding:2rem;color:#D0D4E0;">
        <h3 style="color:#C0C7D4;margin-bottom:1rem;">üß™ Generated Tests</h3>
        <div style="background:#0D0F13;padding:1rem;border-radius:0.5rem;margin-bottom:1rem;">
          <h4 style="color:#8A93A6;margin-bottom:0.5rem;">Coverage: ${data.coverage.coverage_estimate}</h4>
          <div style="color:#6B7280;font-size:0.875rem;">
            ${data.coverage.testable_functions} testable function(s)
          </div>
        </div>
        <div style="background:#1A1D29;padding:1rem;border-radius:0.5rem;">
          <pre style="white-space:pre-wrap;color:#8A93A6;font-size:0.875rem;">${data.tests}</pre>
        </div>
        <button onclick="copyToClipboard(\`${data.tests.replace(/`/g, '\\`')}\`)" style="margin-top:1rem;padding:0.75rem 1.5rem;background:#8A93A6;color:#0D0F13;border:none;border-radius:0.5rem;cursor:pointer;font-weight:600;">Copy Tests</button>
      </div>
    `;
    showNotification('Tests generated!', 'success');
  } catch (error) {
    preview.innerHTML = `<div style="padding:2rem;color:#EF4444;">Error: ${error.message}</div>`;
  }
}

// 4. Performance Profiler
async function analyzePerformance() {
  if (!currentGeneratedCode) {
    showNotification('No code to analyze', 'warning');
    return;
  }
  
  const preview = document.getElementById('previewContent');
  preview.innerHTML = '<div style="padding:2rem;text-align:center;color:#8A93A6;"><div class="spinner"></div> Analyzing performance...</div>';
  
  try {
    const response = await fetch('/analyze-performance', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        code: currentGeneratedCode,
        language: selectedType === 'webapp' ? 'javascript' : 'python'
      })
    });
    
    const data = await response.json();
    const perf = data.performance;
    const comp = data.complexity;
    
    preview.innerHTML = `
      <div style="padding:2rem;color:#D0D4E0;">
        <h3 style="color:#C0C7D4;margin-bottom:1rem;">‚ö° Performance Analysis</h3>
        <div style="background:#0D0F13;padding:1rem;border-radius:0.5rem;margin-bottom:1rem;">
          <div style="font-size:3rem;margin-bottom:0.5rem;">${perf.grade}</div>
          <div style="font-size:1.2rem;color:#8A93A6;">Performance Score: ${perf.score}/100</div>
        </div>
        <div style="background:#1A1D29;padding:1rem;border-radius:0.5rem;margin-bottom:1rem;">
          <h4 style="color:#8A93A6;margin-bottom:0.5rem;">Complexity:</h4>
          <div>${comp.estimated_complexity}</div>
          <div style="font-size:0.875rem;color:#6B7280;">
            Nested loops: ${comp.nested_loops} | Single loops: ${comp.single_loops}
          </div>
        </div>
        ${perf.issues.length > 0 ? `
          <div style="background:#1A1D29;padding:1rem;border-radius:0.5rem;margin-bottom:1rem;">
            <h4 style="color:#8A93A6;margin-bottom:0.5rem;">Issues:</h4>
            ${perf.issues.map(issue => `<div style="color:#F59E0B;margin-bottom:0.25rem;">‚ö†Ô∏è ${issue}</div>`).join('')}
          </div>
        ` : ''}
        ${perf.suggestions.length > 0 ? `
          <div style="background:#1A1D29;padding:1rem;border-radius:0.5rem;">
            <h4 style="color:#8A93A6;margin-bottom:0.5rem;">Suggestions:</h4>
            ${perf.suggestions.map(sug => `<div style="color:#34D399;margin-bottom:0.25rem;">üí° ${sug}</div>`).join('')}
          </div>
        ` : ''}
      </div>
    `;
    showNotification(`Performance grade: ${perf.grade}`, 'success');
  } catch (error) {
    preview.innerHTML = `<div style="padding:2rem;color:#EF4444;">Error: ${error.message}</div>`;
  }
}

// 5. Git Integration - View Status
async function viewGitStatus() {
  const preview = document.getElementById('previewContent');
  preview.innerHTML = '<div style="padding:2rem;text-align:center;color:#8A93A6;"><div class="spinner"></div> Loading git status...</div>';
  
  try {
    const response = await fetch('/git-status', {
      method: 'GET',
      headers: {}
    });
    
    const data = await response.json();
    const status = data.status;
    const history = data.history;
    
    preview.innerHTML = `
      <div style="padding:2rem;color:#D0D4E0;">
        <h3 style="color:#C0C7D4;margin-bottom:1rem;">üìä Git Status</h3>
        <div style="background:#0D0F13;padding:1rem;border-radius:0.5rem;margin-bottom:1rem;">
          <div style="margin-bottom:0.5rem;">Branch: <strong>${status.branch || 'main'}</strong></div>
          <div style="color:#6B7280;">${status.has_changes ? `${status.changes.length} change(s)` : 'No changes'}</div>
        </div>
        ${history.length > 0 ? `
          <div style="background:#1A1D29;padding:1rem;border-radius:0.5rem;">
            <h4 style="color:#8A93A6;margin-bottom:0.5rem;">Recent Commits:</h4>
            ${history.map(commit => `
              <div style="margin-bottom:0.75rem;padding:0.5rem;background:#0D0F13;border-radius:0.25rem;">
                <div style="color:#C0C7D4;font-family:monospace;font-size:0.875rem;">${commit.hash}</div>
                <div style="color:#8A93A6;font-size:0.875rem;">${commit.message}</div>
                <div style="color:#6B7280;font-size:0.75rem;">${commit.date}</div>
              </div>
            `).join('')}
          </div>
        ` : ''}
      </div>
    `;
    showNotification('Git status loaded', 'success');
  } catch (error) {
    preview.innerHTML = `<div style="padding:2rem;color:#EF4444;">Error: ${error.message}</div>`;
  }
}

// 6. Multi-Agent Analysis
async function multiAgentAnalyze() {
  if (!currentGeneratedCode) {
    showNotification('No code to analyze', 'warning');
    return;
  }
  
  const preview = document.getElementById('previewContent');
  preview.innerHTML = '<div style="padding:2rem;text-align:center;color:#8A93A6;"><div class="spinner"></div> Running multi-agent analysis...</div>';
  
  try {
    const response = await fetch('/multi-agent-analyze', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        code: currentGeneratedCode,
        language: selectedType === 'webapp' ? 'javascript' : 'python',
        context: currentPrompt
      })
    });
    
    const data = await response.json();
    const result = data.multi_agent_result;
    
    preview.innerHTML = `
      <div style="padding:2rem;color:#D0D4E0;">
        <h3 style="color:#C0C7D4;margin-bottom:1rem;">ü§ñ Multi-Agent Analysis</h3>
        <div style="background:#0D0F13;padding:1rem;border-radius:0.5rem;margin-bottom:1rem;">
          <div style="font-size:1.2rem;color:#8A93A6;">
            Overall Confidence: ${(result.confidence * 100).toFixed(0)}%
          </div>
        </div>
        ${result.agent_insights.map(insight => `
          <div style="background:#1A1D29;padding:1rem;border-radius:0.5rem;margin-bottom:1rem;">
            <h4 style="color:#8A93A6;margin-bottom:0.5rem;">${insight.agent}</h4>
            <div style="color:#C0C7D4;margin-bottom:0.5rem;">${insight.insight}</div>
            ${insight.issues || insight.recommendations || insight.test_coverage ? `
              <div style="margin-top:0.5rem;padding:0.5rem;background:#0D0F13;border-radius:0.25rem;">
                ${(insight.issues || insight.recommendations || insight.test_coverage || []).map(item => `
                  <div style="color:#6B7280;font-size:0.875rem;margin-bottom:0.25rem;">‚Ä¢ ${item}</div>
                `).join('')}
              </div>
            ` : ''}
            <div style="margin-top:0.5rem;font-size:0.875rem;color:#6B7280;">
              Confidence: ${(insight.confidence * 100).toFixed(0)}%
            </div>
          </div>
        `).join('')}
      </div>
    `;
    showNotification('Multi-agent analysis complete!', 'success');
  } catch (error) {
    preview.innerHTML = `<div style="padding:2rem;color:#EF4444;">Error: ${error.message}</div>`;
  }
}

// Helper function for copying to clipboard
function copyToClipboard(text) {
  navigator.clipboard.writeText(text).then(() => {
    showNotification('Copied to clipboard!', 'success');
  });
}

// ========== TIER 2 FEATURE FUNCTIONS ==========

// 1. Refactoring Engine
async function refactorCode() {
  if (!currentGeneratedCode) {
    showNotification('No code to refactor', 'warning');
    return;
  }
  
  const preview = document.getElementById('previewContent');
  preview.innerHTML = '<div style="padding:2rem;text-align:center;color:#8A93A6;"><div class="spinner"></div> Analyzing code for refactoring...</div>';
  
  try {
    const response = await fetch('/refactor-code', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        code: currentGeneratedCode,
        language: selectedType === 'webapp' ? 'javascript' : 'python'
      })
    });
    
    const data = await response.json();
    const analysis = data.analysis;
    
    const priorityColors = {critical: '#EF4444', high: '#F59E0B', medium: '#9333EA', low: '#6B7280'};
    
    preview.innerHTML = `
      <div style="padding:2rem;color:#D0D4E0;">
        <h3 style="color:#C0C7D4;margin-bottom:1rem;">üîß Refactoring Analysis</h3>
        <div style="background:#0D0F13;padding:1rem;border-radius:0.5rem;margin-bottom:1rem;">
          <div style="display:flex;justify-content:space-between;margin-bottom:0.5rem;">
            <div>Total Suggestions: <strong>${analysis.total_suggestions}</strong></div>
            <div>Modernization: <strong>${data.modernization_score}/100</strong></div>
          </div>
          <div style="display:flex;gap:1rem;font-size:0.875rem;color:#6B7280;">
            <div>Critical: ${analysis.critical}</div>
            <div>High: ${analysis.high}</div>
          </div>
        </div>
        ${analysis.suggestions.map(sug => `
          <div style="background:#1A1D29;padding:1rem;border-radius:0.5rem;margin-bottom:1rem;border-left:3px solid ${priorityColors[sug.priority]};">
            <div style="display:flex;justify-content:space-between;margin-bottom:0.5rem;">
              <strong style="color:#C0C7D4;">${sug.type}</strong>
              <span style="color:${priorityColors[sug.priority]};text-transform:uppercase;font-size:0.75rem;">${sug.priority}</span>
            </div>
            <div style="color:#8A93A6;margin-bottom:0.5rem;font-size:0.875rem;">${sug.location}</div>
            <div style="color:#D0D4E0;margin-bottom:0.5rem;">${sug.issue}</div>
            <div style="color:#34D399;font-size:0.875rem;margin-bottom:0.25rem;">üí° ${sug.suggestion}</div>
            ${sug.example ? `<div style="background:#0D0F13;padding:0.5rem;border-radius:0.25rem;font-family:monospace;font-size:0.8rem;color:#6B7280;margin-top:0.5rem;">${sug.example}</div>` : ''}
          </div>
        `).join('')}
      </div>
    `;
    showNotification(`Found ${analysis.total_suggestions} refactoring suggestion(s)`, 'success');
  } catch (error) {
    preview.innerHTML = `<div style="padding:2rem;color:#EF4444;">Error: ${error.message}</div>`;
  }
}

// 2. Advanced Debugging
async function debugCode() {
  if (!currentGeneratedCode) {
    showNotification('No code to debug', 'warning');
    return;
  }
  
  const preview = document.getElementById('previewContent');
  preview.innerHTML = '<div style="padding:2rem;text-align:center;color:#8A93A6;"><div class="spinner"></div> Debugging code...</div>';
  
  try {
    const response = await fetch('/debug-code', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        code: currentGeneratedCode,
        language: selectedType === 'webapp' ? 'javascript' : 'python'
      })
    });
    
    const data = await response.json();
    const analysis = data.analysis;
    
    const severityColors = {error: '#EF4444', warning: '#F59E0B', info: '#9333EA'};
    
    preview.innerHTML = `
      <div style="padding:2rem;color:#D0D4E0;">
        <h3 style="color:#C0C7D4;margin-bottom:1rem;">üêõ Debug Analysis</h3>
        <div style="background:#0D0F13;padding:1rem;border-radius:0.5rem;margin-bottom:1rem;">
          <div style="display:flex;gap:2rem;">
            <div>Errors: <strong style="color:#EF4444;">${analysis.errors}</strong></div>
            <div>Warnings: <strong style="color:#F59E0B;">${analysis.warnings}</strong></div>
            <div>Total: <strong>${analysis.total_issues}</strong></div>
          </div>
        </div>
        ${analysis.issues.length > 0 ? analysis.issues.map(issue => `
          <div style="background:#1A1D29;padding:1rem;border-radius:0.5rem;margin-bottom:1rem;border-left:3px solid ${severityColors[issue.severity]};">
            <div style="display:flex;justify-content:space-between;margin-bottom:0.5rem;">
              <strong style="color:${severityColors[issue.severity]};">${issue.type}</strong>
              ${issue.line ? `<span style="color:#6B7280;">Line ${issue.line}</span>` : ''}
            </div>
            <div style="color:#D0D4E0;margin-bottom:0.5rem;">${issue.description}</div>
            <div style="color:#34D399;font-size:0.875rem;">‚úì ${issue.fix}</div>
            ${issue.example ? `<div style="background:#0D0F13;padding:0.5rem;border-radius:0.25rem;font-family:monospace;font-size:0.8rem;color:#6B7280;margin-top:0.5rem;">${issue.example}</div>` : ''}
          </div>
        `).join('') : '<div style="color:#34D399;text-align:center;padding:2rem;">‚úì No issues detected!</div>'}
      </div>
    `;
    showNotification(`Found ${analysis.total_issues} issue(s)`, analysis.errors > 0 ? 'warning' : 'success');
  } catch (error) {
    preview.innerHTML = `<div style="padding:2rem;color:#EF4444;">Error: ${error.message}</div>`;
  }
}

// 3. Autonomous Planner
async function planProject() {
  const objective = currentPrompt || prompt('Enter project objective:');
  if (!objective) return;
  
  const preview = document.getElementById('previewContent');
  preview.innerHTML = '<div style="padding:2rem;text-align:center;color:#8A93A6;"><div class="spinner"></div> Creating project plan...</div>';
  
  try {
    const response = await fetch('/plan-project', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        objective: objective,
        language: selectedType === 'webapp' ? 'javascript' : 'python'
      })
    });
    
    const data = await response.json();
    const plan = data.plan;
    
    const statusColors = {pending: '#6B7280', in_progress: '#9333EA', completed: '#34D399', failed: '#EF4444'};
    
    preview.innerHTML = `
      <div style="padding:2rem;color:#D0D4E0;">
        <h3 style="color:#C0C7D4;margin-bottom:1rem;">üéØ Project Execution Plan</h3>
        <div style="background:#0D0F13;padding:1rem;border-radius:0.5rem;margin-bottom:1rem;">
          <div style="margin-bottom:0.5rem;">Progress: <strong>${plan.progress_percentage.toFixed(0)}%</strong></div>
          <div style="display:flex;gap:1rem;font-size:0.875rem;color:#6B7280;">
            <div>Total: ${plan.total_tasks}</div>
            <div>Completed: <span style="color:#34D399;">${plan.completed}</span></div>
            <div>Failed: <span style="color:#EF4444;">${plan.failed}</span></div>
          </div>
        </div>
        <div style="background:#1A1D29;padding:1rem;border-radius:0.5rem;">
          <h4 style="color:#8A93A6;margin-bottom:1rem;">Tasks:</h4>
          ${plan.tasks.map((task, idx) => `
            <div style="padding:0.75rem;background:#0D0F13;border-radius:0.25rem;margin-bottom:0.5rem;border-left:3px solid ${statusColors[task.status]};">
              <div style="display:flex;justify-content:space-between;margin-bottom:0.25rem;">
                <span style="color:#C0C7D4;"><strong>${idx + 1}.</strong> ${task.description}</span>
                <span style="color:${statusColors[task.status]};font-size:0.75rem;text-transform:uppercase;">${task.status}</span>
              </div>
              ${task.error ? `<div style="color:#EF4444;font-size:0.875rem;margin-top:0.25rem;">Error: ${task.error}</div>` : ''}
            </div>
          `).join('')}
        </div>
      </div>
    `;
    showNotification('Project plan created!', 'success');
  } catch (error) {
    preview.innerHTML = `<div style="padding:2rem;color:#EF4444;">Error: ${error.message}</div>`;
  }
}

// 4. Long-Term Memory Stats
async function viewMemoryStats() {
  const preview = document.getElementById('previewContent');
  preview.innerHTML = '<div style="padding:2rem;text-align:center;color:#8A93A6;"><div class="spinner"></div> Loading memory...</div>';
  
  try {
    const response = await fetch('/memory-stats', {
      method: 'GET',
      headers: {}
    });
    
    const data = await response.json();
    const stats = data.stats;
    const lessons = data.recent_lessons;
    
    preview.innerHTML = `
      <div style="padding:2rem;color:#D0D4E0;">
        <h3 style="color:#C0C7D4;margin-bottom:1rem;">üß† Long-Term Memory</h3>
        <div style="background:#0D0F13;padding:1rem;border-radius:0.5rem;margin-bottom:1rem;">
          <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:1rem;">
            <div>
              <div style="font-size:2rem;color:#C0C7D4;">${stats.total_projects}</div>
              <div style="color:#6B7280;font-size:0.875rem;">Projects Stored</div>
            </div>
            <div>
              <div style="font-size:2rem;color:#C0C7D4;">${stats.total_lessons}</div>
              <div style="color:#6B7280;font-size:0.875rem;">Lessons Learned</div>
            </div>
            <div>
              <div style="font-size:2rem;color:#C0C7D4;">${stats.total_patterns}</div>
              <div style="color:#6B7280;font-size:0.875rem;">Patterns Tracked</div>
            </div>
            <div>
              <div style="font-size:2rem;color:#34D399;">${stats.average_verification_score}</div>
              <div style="color:#6B7280;font-size:0.875rem;">Avg Quality Score</div>
            </div>
          </div>
        </div>
        ${lessons.length > 0 ? `
          <div style="background:#1A1D29;padding:1rem;border-radius:0.5rem;">
            <h4 style="color:#8A93A6;margin-bottom:1rem;">Recent Lessons:</h4>
            ${lessons.map(lesson => `
              <div style="padding:0.75rem;background:#0D0F13;border-radius:0.25rem;margin-bottom:0.5rem;">
                <div style="color:#C0C7D4;margin-bottom:0.25rem;">${lesson.lesson}</div>
                <div style="color:#6B7280;font-size:0.75rem;">${lesson.category} ‚Ä¢ ${new Date(lesson.created_at).toLocaleDateString()}</div>
              </div>
            `).join('')}
          </div>
        ` : ''}
      </div>
    `;
    showNotification('Memory stats loaded', 'success');
  } catch (error) {
    preview.innerHTML = `<div style="padding:2rem;color:#EF4444;">Error: ${error.message}</div>`;
  }
}

// Live Code Streaming Animation (Replit Agent Style)
async function animateCodeStreaming(container, code, language) {
  return new Promise(resolve => {
    // Prepare container
    container.innerHTML = `
      <pre style="margin:0;height:100%;overflow-y:auto;"><code class="language-${language}" id="streamingCode" style="display:block;white-space:pre;line-height:1.65;"></code></pre>
    `;
    
    const codeElement = document.getElementById('streamingCode');
    let currentText = '';
    let charIndex = 0;
    
    // Strip markdown code fences if present
    let cleanCode = code.replace(/^```\w*\n?/, '').replace(/\n?```$/, '');
    
    // Streaming speed - faster for better UX (like Replit Agent)
    const charsPerFrame = 3; // Type 3 characters at a time for smooth animation
    const frameDelay = 10; // 10ms between frames = ~100 chars/sec
    
    const streamInterval = setInterval(() => {
      if (charIndex >= cleanCode.length) {
        clearInterval(streamInterval);
        
        // Final update with syntax highlighting
        codeElement.textContent = cleanCode;
        if (typeof Prism !== 'undefined') {
          Prism.highlightElement(codeElement);
        }
        
        resolve();
        return;
      }
      
      // Add characters
      const chunk = cleanCode.slice(charIndex, charIndex + charsPerFrame);
      currentText += chunk;
      charIndex += charsPerFrame;
      
      // Update display (plain text during streaming for performance)
      codeElement.textContent = currentText;
      
      // Auto-scroll to bottom
      const pre = container.querySelector('pre');
      if (pre) {
        pre.scrollTop = pre.scrollHeight;
      }
    }, frameDelay);
  });
}

// Load shared code from URL
window.addEventListener('DOMContentLoaded', () => {
  const params = new URLSearchParams(window.location.search);
  const shared = params.get('shared');
  
  if (shared) {
    try {
      const decoded = JSON.parse(atob(shared));
      currentGeneratedCode = decoded.code;
      currentPrompt = decoded.prompt;
      
      document.getElementById('ideaInput').value = decoded.prompt;
      
      showNotification('üì• Loaded shared code!', 'success');
      
      // Auto-open modal with code
      setTimeout(() => {
        const modal = document.getElementById('buildModal');
        modal.style.cssText = 'display: flex !important;';
        modal.classList.add('active');
        
        const codeContent = document.getElementById('codeContent');
        const lang = decoded.language === 'webapp' ? 'javascript' : 'python';
        
        codeContent.innerHTML = `
          <pre style="margin:0;height:100%;overflow-y:auto;"><code class="language-${lang}" style="display:block;white-space:pre;line-height:1.65;">${escapeHtml(decoded.code)}</code></pre>
        `;
        
        if (typeof Prism !== 'undefined') {
          Prism.highlightAll();
        }
      }, 500);
      
      // Clean URL
      window.history.replaceState({}, document.title, window.location.pathname);
    } catch (error) {
      console.error('Failed to load shared code:', error);
    }
  }
});

// Animated Particle Background - Replit Agent Style
(function() {
  const canvas = document.getElementById('particles-canvas');
  const ctx = canvas.getContext('2d');
  
  let particles = [];
  const particleCount = 80;
  
  // Set canvas size
  function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
  }
  resizeCanvas();
  window.addEventListener('resize', resizeCanvas);
  
  // Particle class
  class Particle {
    constructor() {
      this.x = Math.random() * canvas.width;
      this.y = Math.random() * canvas.height;
      this.vx = (Math.random() - 0.5) * 0.5;
      this.vy = (Math.random() - 0.5) * 0.5;
      this.radius = Math.random() * 2 + 1;
      this.opacity = Math.random() * 0.5 + 0.2;
    }
    
    update() {
      this.x += this.vx;
      this.y += this.vy;
      
      // Wrap around edges
      if (this.x < 0) this.x = canvas.width;
      if (this.x > canvas.width) this.x = 0;
      if (this.y < 0) this.y = canvas.height;
      if (this.y > canvas.height) this.y = 0;
    }
    
    draw() {
      ctx.beginPath();
      ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
      ctx.fillStyle = `rgba(147, 51, 234, ${this.opacity})`;
      ctx.fill();
    }
  }
  
  // Create particles
  for (let i = 0; i < particleCount; i++) {
    particles.push(new Particle());
  }
  
  // Animation loop
  function animate() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Update and draw particles
    particles.forEach(particle => {
      particle.update();
      particle.draw();
    });
    
    // Draw connections
    particles.forEach((p1, i) => {
      particles.slice(i + 1).forEach(p2 => {
        const dx = p1.x - p2.x;
        const dy = p1.y - p2.y;
        const distance = Math.sqrt(dx * dx + dy * dy);
        
        if (distance < 120) {
          const opacity = (1 - distance / 120) * 0.15;
          ctx.beginPath();
          ctx.moveTo(p1.x, p1.y);
          ctx.lineTo(p2.x, p2.y);
          ctx.strokeStyle = `rgba(147, 51, 234, ${opacity})`;
          ctx.lineWidth = 0.5;
          ctx.stroke();
        }
      });
    });
    
    requestAnimationFrame(animate);
  }
  
  animate();
})();

// Show Dev Tools - Full Replit Agent Capabilities
function showDevTools() {
  showNotification('‚ö° SuperAgent now has ALL Replit Agent capabilities!', 'success');
  
  const modal = document.getElementById('buildModal');
  const codeContent = document.getElementById('codeContent');
  
  codeContent.innerHTML = `
    <div style="padding:2rem;color:#C0C7D4;overflow-y:auto;height:100%;">
      <h2 style="color:#9333EA;margin:0 0 1.5rem 0;">‚ö° Development Tools</h2>
      <p style="color:#8A93A6;margin-bottom:2rem;">SuperAgent now includes ALL Replit Agent capabilities!</p>
      
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:0.75rem;">
        
        <div style="background:#1C1F2B;padding:1rem;border-radius:0.5rem;border:1px solid rgba(102,126,234,0.2);">
          <h3 style="color:#9333EA;margin:0 0 0.3rem 0;font-size:0.9rem;">üìÅ File Operations</h3>
          <p style="color:#8A93A6;font-size:0.75rem;margin:0;">Read, write, delete files</p>
        </div>
        
        <div style="background:#1C1F2B;padding:1rem;border-radius:0.5rem;border:1px solid rgba(102,126,234,0.2);">
          <h3 style="color:#9333EA;margin:0 0 0.3rem 0;font-size:0.9rem;">üîç Code Search</h3>
          <p style="color:#8A93A6;font-size:0.75rem;margin:0;">Find functions & classes</p>
        </div>
        
        <div style="background:#1C1F2B;padding:1rem;border-radius:0.5rem;border:1px solid rgba(102,126,234,0.2);">
          <h3 style="color:#9333EA;margin:0 0 0.3rem 0;font-size:0.9rem;">‚å®Ô∏è Command Execution</h3>
          <p style="color:#8A93A6;font-size:0.75rem;margin:0;">Run shell commands</p>
        </div>
        
        <div style="background:#1C1F2B;padding:1rem;border-radius:0.5rem;border:1px solid rgba(102,126,234,0.2);">
          <h3 style="color:#9333EA;margin:0 0 0.3rem 0;font-size:0.9rem;">üåê Web Search</h3>
          <p style="color:#8A93A6;font-size:0.75rem;margin:0;">Search docs & APIs</p>
        </div>
        
        <div style="background:#1C1F2B;padding:1rem;border-radius:0.5rem;border:1px solid rgba(102,126,234,0.2);">
          <h3 style="color:#9333EA;margin:0 0 0.3rem 0;font-size:0.9rem;">üóÑÔ∏è Database</h3>
          <p style="color:#8A93A6;font-size:0.75rem;margin:0;">SQL queries & tables</p>
        </div>
        
        <div style="background:#1C1F2B;padding:1rem;border-radius:0.5rem;border:1px solid rgba(102,126,234,0.2);">
          <h3 style="color:#9333EA;margin:0 0 0.3rem 0;font-size:0.9rem;">üîê Environment</h3>
          <p style="color:#8A93A6;font-size:0.75rem;margin:0;">Secrets & env vars</p>
        </div>
        
        <div style="background:#1C1F2B;padding:1rem;border-radius:0.5rem;border:1px solid rgba(102,126,234,0.2);">
          <h3 style="color:#9333EA;margin:0 0 0.3rem 0;font-size:0.9rem;">üöÄ Deployment</h3>
          <p style="color:#8A93A6;font-size:0.75rem;margin:0;">Production config</p>
        </div>
        
        <div style="background:#1C1F2B;padding:1rem;border-radius:0.5rem;border:1px solid rgba(102,126,234,0.2);">
          <h3 style="color:#9333EA;margin:0 0 0.3rem 0;font-size:0.9rem;">üìä Project Analysis</h3>
          <p style="color:#8A93A6;font-size:0.75rem;margin:0;">Detect project type</p>
        </div>
        
        <div style="background:#1C1F2B;padding:1rem;border-radius:0.5rem;border:1px solid rgba(245,158,11,0.2);">
          <h3 style="color:#f59e0b;margin:0 0 0.3rem 0;font-size:0.9rem;">üëÅÔ∏è 2-Supervisor</h3>
          <p style="color:#8A93A6;font-size:0.75rem;margin:0;">Parallel verification</p>
        </div>
        
        <div style="background:#1C1F2B;padding:1rem;border-radius:0.5rem;border:1px solid rgba(245,158,11,0.2);">
          <h3 style="color:#f59e0b;margin:0 0 0.3rem 0;font-size:0.9rem;">üåê Multi-AI</h3>
          <p style="color:#8A93A6;font-size:0.75rem;margin:0;">4 AI providers</p>
        </div>
        
        <div style="background:#1C1F2B;padding:1rem;border-radius:0.5rem;border:1px solid rgba(245,158,11,0.2);">
          <h3 style="color:#f59e0b;margin:0 0 0.3rem 0;font-size:0.9rem;">üîí Security Scan</h3>
          <p style="color:#8A93A6;font-size:0.75rem;margin:0;">Vulnerability detection</p>
        </div>
        
        <div style="background:#1C1F2B;padding:1rem;border-radius:0.5rem;border:1px solid rgba(245,158,11,0.2);">
          <h3 style="color:#f59e0b;margin:0 0 0.3rem 0;font-size:0.9rem;">üîå Plugins</h3>
          <p style="color:#8A93A6;font-size:0.75rem;margin:0;">Extensible system</p>
        </div>
        
        <div style="background:#1C1F2B;padding:1rem;border-radius:0.5rem;border:1px solid rgba(245,158,11,0.2);">
          <h3 style="color:#f59e0b;margin:0 0 0.3rem 0;font-size:0.9rem;">‚å®Ô∏è CLI Tool</h3>
          <p style="color:#8A93A6;font-size:0.75rem;margin:0;">Command-line</p>
        </div>
        
        <div style="background:#1C1F2B;padding:1rem;border-radius:0.5rem;border:1px solid rgba(245,158,11,0.2);">
          <h3 style="color:#f59e0b;margin:0 0 0.3rem 0;font-size:0.9rem;">üìã Structured Logs</h3>
          <p style="color:#8A93A6;font-size:0.75rem;margin:0;">Production logging</p>
        </div>
        
        <div style="background:#1C1F2B;padding:1rem;border-radius:0.5rem;border:1px solid rgba(245,158,11,0.2);">
          <h3 style="color:#f59e0b;margin:0 0 0.3rem 0;font-size:0.9rem;">üîå Integrations</h3>
          <p style="color:#8A93A6;font-size:0.75rem;margin:0;">Stripe, Auth, APIs</p>
        </div>
        
        <div style="background:#1C1F2B;padding:1rem;border-radius:0.5rem;border:1px solid rgba(245,158,11,0.2);">
          <h3 style="color:#f59e0b;margin:0 0 0.3rem 0;font-size:0.9rem;">üé® Image Gen</h3>
          <p style="color:#8A93A6;font-size:0.75rem;margin:0;">AI image creation</p>
        </div>
        
        <div style="background:#1C1F2B;padding:1rem;border-radius:0.5rem;border:1px solid rgba(245,158,11,0.2);">
          <h3 style="color:#f59e0b;margin:0 0 0.3rem 0;font-size:0.9rem;">üì∏ Stock Images</h3>
          <p style="color:#8A93A6;font-size:0.75rem;margin:0;">Photo library</p>
        </div>
        
        <div style="background:#1C1F2B;padding:1rem;border-radius:0.5rem;border:1px solid rgba(245,158,11,0.2);">
          <h3 style="color:#f59e0b;margin:0 0 0.3rem 0;font-size:0.9rem;">üìä Enhanced Git</h3>
          <p style="color:#8A93A6;font-size:0.75rem;margin:0;">Diff, branches, log</p>
        </div>
        
        <div onclick="showSelfRepairStatus()" style="background:linear-gradient(135deg,rgba(16,185,129,0.2),rgba(52,211,153,0.2));padding:1rem;border-radius:0.5rem;border:2px solid #10B981;cursor:pointer;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
          <h3 style="color:#10B981;margin:0 0 0.3rem 0;font-size:0.9rem;">üîß Self-Repair</h3>
          <p style="color:#34D399;font-size:0.75rem;margin:0;font-weight:600;">Auto-fix errors ‚ú®</p>
        </div>
        
        <div style="background:#1C1F2B;padding:1rem;border-radius:0.5rem;border:1px solid rgba(245,158,11,0.2);">
          <h3 style="color:#f59e0b;margin:0 0 0.3rem 0;font-size:0.9rem;">üîç LSP Diagnostics</h3>
          <p style="color:#8A93A6;font-size:0.75rem;margin:0;">Syntax error detection</p>
        </div>
        
        <div style="background:#1C1F2B;padding:1rem;border-radius:0.5rem;border:1px solid rgba(245,158,11,0.2);">
          <h3 style="color:#f59e0b;margin:0 0 0.3rem 0;font-size:0.9rem;">ü§ñ Autonomous</h3>
          <p style="color:#8A93A6;font-size:0.75rem;margin:0;">Full AI automation</p>
        </div>
        
        <div style="background:#1C1F2B;padding:1rem;border-radius:0.5rem;border:1px solid rgba(16,185,129,0.2);">
          <h3 style="color:#10b981;margin:0 0 0.3rem 0;font-size:0.9rem;">üîÑ Rollback</h3>
          <p style="color:#8A93A6;font-size:0.75rem;margin:0;">Checkpoints & restore</p>
        </div>
        
        <div style="background:#1C1F2B;padding:1rem;border-radius:0.5rem;border:1px solid rgba(16,185,129,0.2);">
          <h3 style="color:#10b981;margin:0 0 0.3rem 0;font-size:0.9rem;">üì∏ Screenshots</h3>
          <p style="color:#8A93A6;font-size:0.75rem;margin:0;">UI capture & debug</p>
        </div>
        
        <div style="background:#1C1F2B;padding:1rem;border-radius:0.5rem;border:1px solid rgba(16,185,129,0.2);">
          <h3 style="color:#10b981;margin:0 0 0.3rem 0;font-size:0.9rem;">üì¶ Modules</h3>
          <p style="color:#8A93A6;font-size:0.75rem;margin:0;">Install languages</p>
        </div>
        
        <div style="background:#1C1F2B;padding:1rem;border-radius:0.5rem;border:1px solid rgba(16,185,129,0.2);">
          <h3 style="color:#10b981;margin:0 0 0.3rem 0;font-size:0.9rem;">üèóÔ∏è Scaffolding</h3>
          <p style="color:#8A93A6;font-size:0.75rem;margin:0;">Project templates</p>
        </div>
        
        <div style="background:#1C1F2B;padding:1rem;border-radius:0.5rem;border:1px solid rgba(16,185,129,0.2);">
          <h3 style="color:#10b981;margin:0 0 0.3rem 0;font-size:0.9rem;">‚öôÔ∏è Workflows</h3>
          <p style="color:#8A93A6;font-size:0.75rem;margin:0;">Task management</p>
        </div>
        
      </div>
      
      <div style="margin-top:2rem;padding:1.5rem;background:linear-gradient(135deg,rgba(102,126,234,0.2),rgba(118,75,162,0.2));border-radius:0.75rem;border:1px solid rgba(102,126,234,0.5);">
        <h3 style="color:#9333EA;margin:0 0 0.75rem 0;">üéØ Total Features: 71+</h3>
        <ul style="color:#C0C7D4;margin:0;padding-left:1.5rem;">
          <li style="margin:0.5rem 0;">‚úÖ 32 Original SuperAgent features</li>
          <li style="margin:0.5rem 0;">‚úÖ 12 ERAGENT enterprise features</li>
          <li style="margin:0.5rem 0;">‚úÖ 8 Replit Agent capabilities</li>
          <li style="margin:0.5rem 0;">‚úÖ 7 Platform integrations</li>
          <li style="margin:0.5rem 0;">‚úÖ 6 NEW Advanced features (2-Supervisor, Multi-AI, Security, Plugins, CLI, Logging)</li>
          <li style="margin:0.5rem 0;">‚úÖ 1 Autonomous Agent</li>
          <li style="margin:0.5rem 0;">‚úÖ 5 Advanced platform tools (NEW!)</li>
        </ul>
        <p style="color:#8A93A6;margin-top:1rem;margin-bottom:0;">All features accessible via API endpoints. Check <strong>/docs</strong> for full API reference.</p>
      </div>
    </div>
  `;
  
  modal.style.cssText = 'display: flex !important;';
  modal.classList.add('active');
}

// Show Agent Mode - FULLY AUTONOMOUS
async function showAgentMode() {
  const modal = document.getElementById('buildModal');
  const codeContent = document.getElementById('codeContent');
  
  codeContent.innerHTML = `
    <div style="padding:2rem;color:#C0C7D4;overflow-y:auto;height:100%;">
      <h2 style="color:#f59e0b;margin:0 0 1rem 0;">ü§ñ Autonomous Agent Mode</h2>
      <p style="color:#8A93A6;margin-bottom:2rem;font-size:0.95rem;">SuperAgent is now FULLY AUTONOMOUS! Give it any task in natural language and it will plan, execute, and complete it automatically.</p>
      
      <div style="background:linear-gradient(135deg,rgba(245,158,11,0.2),rgba(239,68,68,0.2));padding:2rem;border-radius:1rem;border:2px solid rgba(245,158,11,0.5);margin-bottom:2rem;">
        <h3 style="color:#f59e0b;margin:0 0 1rem 0;font-size:1.2rem;">‚ú® What Makes This Special?</h3>
        <div style="display:grid;gap:1rem;">
          <div style="display:flex;align-items:flex-start;gap:0.75rem;">
            <span style="color:#f59e0b;font-size:1.5rem;">üß†</span>
            <div>
              <strong style="color:#C0C7D4;">Intelligent Planning</strong>
              <p style="color:#8A93A6;margin:0.25rem 0 0 0;font-size:0.85rem;">AI creates a multi-step plan to accomplish your goal</p>
            </div>
          </div>
          <div style="display:flex;align-items:flex-start;gap:0.75rem;">
            <span style="color:#f59e0b;font-size:1.5rem;">‚ö°</span>
            <div>
              <strong style="color:#C0C7D4;">Autonomous Execution</strong>
              <p style="color:#8A93A6;margin:0.25rem 0 0 0;font-size:0.85rem;">Executes all steps automatically without human intervention</p>
            </div>
          </div>
          <div style="display:flex;align-items:flex-start;gap:0.75rem;">
            <span style="color:#f59e0b;font-size:1.5rem;">üõ°Ô∏è</span>
            <div>
              <strong style="color:#C0C7D4;">Error Recovery</strong>
              <p style="color:#8A93A6;margin:0.25rem 0 0 0;font-size:0.85rem;">Detects failures and tries alternative approaches</p>
            </div>
          </div>
          <div style="display:flex;align-items:flex-start;gap:0.75rem;">
            <span style="color:#f59e0b;font-size:1.5rem;">üîß</span>
            <div>
              <strong style="color:#C0C7D4;">All Tools Available</strong>
              <p style="color:#8A93A6;margin:0.25rem 0 0 0;font-size:0.85rem;">Uses all 50+ features: file ops, commands, web search, database, deployment</p>
            </div>
          </div>
        </div>
      </div>
      
      <div style="background:#1C1F2B;padding:1.5rem;border-radius:0.75rem;margin-bottom:1.5rem;">
        <h3 style="color:#9333EA;margin:0 0 1rem 0;">Try These Examples:</h3>
        <div style="display:grid;gap:0.75rem;font-size:0.85rem;">
          <div style="background:#0D0F13;padding:1rem;border-radius:0.5rem;cursor:pointer;" onclick="runAutonomousTask('Add user authentication to my app with login and signup pages')">
            <strong style="color:#C0C7D4;">üîê "Add user authentication to my app"</strong>
            <p style="color:#6B7280;margin:0.5rem 0 0 0;">Agent will: analyze project ‚Üí install packages ‚Üí create auth system ‚Üí add login/signup pages</p>
          </div>
          <div style="background:#0D0F13;padding:1rem;border-radius:0.5rem;cursor:pointer;" onclick="runAutonomousTask('Create a PostgreSQL database with users and posts tables')">
            <strong style="color:#C0C7D4;">üóÑÔ∏è "Create a database with users and posts tables"</strong>
            <p style="color:#6B7280;margin:0.5rem 0 0 0;">Agent will: setup database ‚Üí create tables ‚Üí add relationships ‚Üí generate migration code</p>
          </div>
          <div style="background:#0D0F13;padding:1rem;border-radius:0.5rem;cursor:pointer;" onclick="runAutonomousTask('Fix all bugs in my code and optimize performance')">
            <strong style="color:#C0C7D4;">üêõ "Fix bugs and optimize performance"</strong>
            <p style="color:#6B7280;margin:0.5rem 0 0 0;">Agent will: analyze code ‚Üí find bugs ‚Üí search for solutions ‚Üí apply fixes ‚Üí test</p>
          </div>
        </div>
      </div>
      
      <div>
        <label style="display:block;color:#C0C7D4;margin-bottom:0.5rem;font-weight:600;">Enter Your Task:</label>
        <textarea id="agentTaskInput" placeholder="E.g., Add Stripe payment integration to my Flask app" 
          style="width:100%;min-height:100px;background:#0D0F13;border:1px solid rgba(102,126,234,0.3);border-radius:0.5rem;padding:1rem;color:#C0C7D4;font-size:0.9rem;font-family:inherit;resize:vertical;"></textarea>
        <button onclick="runAutonomousTask()" 
          style="margin-top:1rem;background:linear-gradient(135deg,#f59e0b,#ef4444);color:white;border:none;padding:0.75rem 2rem;border-radius:0.5rem;cursor:pointer;font-weight:700;font-size:1rem;width:100%;box-shadow:0 4px 12px rgba(245,158,11,0.4);">
          ü§ñ Execute Autonomously
        </button>
      </div>
    </div>
  `;
  
  modal.style.cssText = 'display: flex !important;';
  modal.classList.add('active');
}

async function runAutonomousTask(predefinedTask) {
  const taskInput = document.getElementById('agentTaskInput');
  const task = predefinedTask || taskInput.value.trim();
  
  if (!task) {
    showNotification('Please enter a task', 'warning');
    return;
  }
  
  showNotification('ü§ñ Agent is planning and executing...', 'info');
  
  const codeContent = document.getElementById('codeContent');
  codeContent.innerHTML = `
    <div style="padding:2rem;color:#C0C7D4;">
      <h3 style="color:#f59e0b;margin:0 0 1rem 0;">ü§ñ Agent Working...</h3>
      <div style="background:#0D0F13;padding:1.5rem;border-radius:0.75rem;margin-bottom:1rem;">
        <div style="color:#8A93A6;">Task: <strong style="color:#C0C7D4;">${task}</strong></div>
        <div style="margin-top:1rem;color:#6B7280;">
          <div class="loading-spinner" style="display:inline-block;width:12px;height:12px;border:2px solid #f59e0b;border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite;margin-right:0.5rem;"></div>
          Planning and executing autonomously...
        </div>
      </div>
    </div>
  `;
  
  try {
    const response = await fetch('/agent/execute', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ task })
    });
    
    const result = await response.json();
    
    if (result.success) {
      codeContent.innerHTML = `
        <div style="padding:2rem;color:#C0C7D4;overflow-y:auto;height:100%;">
          <h3 style="color:#34D399;margin:0 0 1rem 0;">‚úÖ Task Completed!</h3>
          
          <div style="background:#0D0F13;padding:1.5rem;border-radius:0.75rem;margin-bottom:1.5rem;">
            <strong style="color:#C0C7D4;">Task:</strong>
            <div style="color:#8A93A6;margin-top:0.5rem;">${task}</div>
          </div>
          
          <div style="background:#0D0F13;padding:1.5rem;border-radius:0.75rem;margin-bottom:1.5rem;">
            <strong style="color:#9333EA;">üìã Execution Plan:</strong>
            <div style="margin-top:1rem;">
              ${result.plan.map((step, i) => `
                <div style="margin:0.75rem 0;padding:0.75rem;background:#1C1F2B;border-radius:0.5rem;">
                  <div style="color:#C0C7D4;"><strong>Step ${step.step}:</strong> ${step.description}</div>
                  <div style="color:#6B7280;font-size:0.85rem;margin-top:0.25rem;">Action: ${step.action}</div>
                </div>
              `).join('')}
            </div>
          </div>
          
          <div style="background:#0D0F13;padding:1.5rem;border-radius:0.75rem;">
            <strong style="color:#34D399;">‚úÖ Results:</strong>
            <div style="margin-top:1rem;font-family:monospace;font-size:0.85rem;">
              <pre style="margin:0;white-space:pre-wrap;color:#8A93A6;">${JSON.stringify(result.results, null, 2)}</pre>
            </div>
          </div>
          
          <div style="margin-top:1.5rem;padding:1rem;background:linear-gradient(135deg,rgba(52,211,153,0.2),rgba(16,185,129,0.2));border-radius:0.75rem;border:1px solid rgba(52,211,153,0.5);">
            <strong style="color:#34D399;">üéâ Total Steps Executed: ${result.steps_executed}</strong>
          </div>
        </div>
      `;
      showNotification('‚úÖ Task completed successfully!', 'success');
    } else {
      throw new Error(result.error || 'Task failed');
    }
  } catch (error) {
    codeContent.innerHTML = `
      <div style="padding:2rem;color:#C0C7D4;">
        <h3 style="color:#EF4444;">‚ùå Error</h3>
        <div style="background:#0D0F13;padding:1.5rem;border-radius:0.75rem;margin-top:1rem;">
          <div style="color:#8A93A6;">${error.message}</div>
        </div>
      </div>
    `;
    showNotification('Task failed: ' + error.message, 'error');
  }
}

// ===== MULTIPLAYER COLLABORATION =====
let multiplayerWs = null;
let currentRoomId = null;
let currentJoinLink = null;

function showMultiplayerModal() {
  const modal = document.getElementById('buildModal');
  const codeContent = document.getElementById('codeContent');
  
  codeContent.innerHTML = `
    <div style="padding:2rem;color:#C0C7D4;overflow-y:auto;height:100%;">
      <h2 style="color:#10B981;margin:0 0 1rem 0;">üë• Multiplayer Collaboration</h2>
      <p style="color:#8A93A6;margin-bottom:2rem;font-size:0.95rem;">Code together in real-time with up to 4 users. Share your workspace instantly!</p>
      
      <div style="display:grid;gap:1.5rem;">
        <!-- Create Room -->
        <div style="background:#1C1F2B;padding:1.5rem;border-radius:0.75rem;border:1px solid rgba(16,185,129,0.3);">
          <h3 style="color:#10B981;margin:0 0 1rem 0;font-size:1.1rem;">üöÄ Create New Room</h3>
          <p style="color:#8A93A6;margin-bottom:1rem;font-size:0.85rem;">Start a new collaboration session and get a join link to share</p>
          <input id="ownerUsername" placeholder="Your name" 
            style="width:100%;background:#0D0F13;border:1px solid rgba(16,185,129,0.3);border-radius:0.5rem;padding:0.75rem;color:#C0C7D4;margin-bottom:1rem;"/>
          <button onclick="createMultiplayerRoom()" 
            style="width:100%;background:linear-gradient(135deg,#10B981,#34D399);color:white;border:none;padding:0.75rem;border-radius:0.5rem;cursor:pointer;font-weight:700;">
            Create Room & Get Join Link
          </button>
        </div>
        
        <!-- Join Room -->
        <div style="background:#1C1F2B;padding:1.5rem;border-radius:0.75rem;border:1px solid rgba(147,51,234,0.3);">
          <h3 style="color:#9333EA;margin:0 0 1rem 0;font-size:1.1rem;">üîó Join Existing Room</h3>
          <p style="color:#8A93A6;margin-bottom:1rem;font-size:0.85rem;">Have a join link? Enter it below to join a session</p>
          <input id="joinLinkInput" placeholder="Paste join link here" 
            style="width:100%;background:#0D0F13;border:1px solid rgba(147,51,234,0.3);border-radius:0.5rem;padding:0.75rem;color:#C0C7D4;margin-bottom:0.75rem;"/>
          <input id="joinUsername" placeholder="Your name" 
            style="width:100%;background:#0D0F13;border:1px solid rgba(147,51,234,0.3);border-radius:0.5rem;padding:0.75rem;color:#C0C7D4;margin-bottom:1rem;"/>
          <button onclick="joinMultiplayerRoom()" 
            style="width:100%;background:linear-gradient(135deg,#9333EA,#A855F7);color:white;border:none;padding:0.75rem;border-radius:0.5rem;cursor:pointer;font-weight:700;">
            Join Room
          </button>
        </div>
        
        <!-- Features -->
        <div style="background:linear-gradient(135deg,rgba(16,185,129,0.1),rgba(52,211,153,0.1));padding:1.5rem;border-radius:0.75rem;border:1px solid rgba(16,185,129,0.3);">
          <h3 style="color:#34D399;margin:0 0 1rem 0;">‚ú® Real-Time Features</h3>
          <div style="display:grid;gap:0.75rem;font-size:0.85rem;">
            <div style="display:flex;align-items:center;gap:0.5rem;">
              <span style="color:#10B981;">‚úì</span>
              <span>Live code synchronization (see everyone's edits)</span>
            </div>
            <div style="display:flex;align-items:center;gap:0.5rem;">
              <span style="color:#10B981;">‚úì</span>
              <span>Real-time cursor positions</span>
            </div>
            <div style="display:flex;align-items:center;gap:0.5rem;">
              <span style="color:#10B981;">‚úì</span>
              <span>User presence (see who's online)</span>
            </div>
            <div style="display:flex;align-items:center;gap:0.5rem;">
              <span style="color:#10B981;">‚úì</span>
              <span>Observation mode (watch collaborators code)</span>
            </div>
            <div style="display:flex;align-items:center;gap:0.5rem;">
              <span style="color:#10B981;">‚úì</span>
              <span>Up to 4 users per room</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
  
  modal.style.cssText = 'display: flex !important;';
  modal.classList.add('active');
}

async function createMultiplayerRoom() {
  const usernameInput = document.getElementById('ownerUsername');
  const username = usernameInput.value.trim() || 'Anonymous';
  
  try {
    const response = await fetch('/multiplayer/create-room', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username })
    });
    
    const result = await response.json();
    
    if (result.success) {
      currentRoomId = result.room_id;
      currentJoinLink = result.join_link;
      
      const codeContent = document.getElementById('codeContent');
      codeContent.innerHTML = `
        <div style="padding:2rem;color:#C0C7D4;">
          <h2 style="color:#34D399;margin:0 0 1rem 0;">‚úÖ Room Created!</h2>
          
          <div style="background:#1C1F2B;padding:1.5rem;border-radius:0.75rem;margin-bottom:1.5rem;">
            <h3 style="color:#10B981;margin:0 0 1rem 0;">üìã Share This Link:</h3>
            <div style="background:#0D0F13;padding:1rem;border-radius:0.5rem;border:1px solid rgba(16,185,129,0.3);display:flex;align-items:center;justify-content:space-between;">
              <code style="color:#34D399;flex:1;word-break:break-all;">${result.join_link}</code>
              <button onclick="navigator.clipboard.writeText('${result.join_link}'); showNotification('Link copied!', 'success')" 
                style="background:#10B981;color:white;border:none;padding:0.5rem 1rem;border-radius:0.25rem;cursor:pointer;margin-left:1rem;">
                Copy
              </button>
            </div>
          </div>
          
          <div style="background:#1C1F2B;padding:1.5rem;border-radius:0.75rem;margin-bottom:1.5rem;">
            <h3 style="color:#9333EA;margin:0 0 0.75rem 0;">üë• Collaborators: <span id="userCount">1</span>/4</h3>
            <div id="userList" style="display:grid;gap:0.5rem;"></div>
          </div>
          
          <button onclick="connectToRoom('${result.room_id}', '${username}')" 
            style="width:100%;background:linear-gradient(135deg,#10B981,#34D399);color:white;border:none;padding:0.75rem;border-radius:0.5rem;cursor:pointer;font-weight:700;">
            üöÄ Start Collaboration
          </button>
        </div>
      `;
      
      showNotification('Room created! Share the link with collaborators', 'success');
    }
  } catch (error) {
    showNotification('Failed to create room: ' + error.message, 'error');
  }
}

async function joinMultiplayerRoom() {
  const joinLinkInput = document.getElementById('joinLinkInput');
  const usernameInput = document.getElementById('joinUsername');
  
  const joinLink = joinLinkInput.value.trim();
  const username = usernameInput.value.trim() || 'Anonymous';
  
  if (!joinLink) {
    showNotification('Please enter a join link', 'warning');
    return;
  }
  
  currentJoinLink = joinLink;
  
  showNotification('Joining room...', 'info');
  connectToRoom(null, username, joinLink);
}

function connectToRoom(roomId, username, joinLink) {
  // Close existing connection
  if (multiplayerWs) {
    multiplayerWs.close();
  }
  
  // Construct WebSocket URL
  const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
  const wsUrl = `${wsProtocol}//${window.location.host}/multiplayer/ws/${roomId || 'temp'}`;
  
  multiplayerWs = new WebSocket(wsUrl);
  
  multiplayerWs.onopen = () => {
    // Send join message
    multiplayerWs.send(JSON.stringify({
      type: 'join',
      username: username,
      join_link: joinLink,
      user_id: localStorage.getItem('user_id') || generateUserId()
    }));
  };
  
  multiplayerWs.onmessage = (event) => {
    const message = JSON.parse(event.data);
    handleMultiplayerMessage(message);
  };
  
  multiplayerWs.onerror = (error) => {
    showNotification('Connection error', 'error');
    console.error('WebSocket error:', error);
  };
  
  multiplayerWs.onclose = () => {
    showNotification('Disconnected from room', 'info');
    multiplayerWs = null;
  };
}

function handleMultiplayerMessage(message) {
  const { type } = message;
  
  if (type === 'init') {
    // Room initialized
    showNotification(`Connected! ${message.users.length} users online`, 'success');
    updateUserList(message.users);
  }
  else if (type === 'user_joined') {
    showNotification(`${message.user.username} joined`, 'info');
    updateUserCount(message.total_users);
  }
  else if (type === 'user_left') {
    showNotification(`User left`, 'info');
    updateUserCount(message.total_users);
  }
  else if (type === 'code_update') {
    // Handle incoming code changes
    showNotification(`${message.username} updated code`, 'info');
  }
  else if (type === 'cursor_update') {
    // Show cursor position
  }
}

function updateUserList(users) {
  const userListEl = document.getElementById('userList');
  if (userListEl) {
    userListEl.innerHTML = users.map(user => `
      <div style="background:#0D0F13;padding:0.75rem;border-radius:0.5rem;display:flex;align-items:center;gap:0.5rem;">
        <div style="width:8px;height:8px;background:#34D399;border-radius:50%;"></div>
        <span>${user.username}</span>
        ${user.is_owner ? '<span style="background:#9333EA;padding:0.2rem 0.5rem;border-radius:0.25rem;font-size:0.7rem;margin-left:auto;">Owner</span>' : ''}
      </div>
    `).join('');
  }
}

function updateUserCount(count) {
  const userCountEl = document.getElementById('userCount');
  if (userCountEl) {
    userCountEl.textContent = count;
  }
}

function generateUserId() {
  const userId = 'user_' + Math.random().toString(36).substr(2, 9);
  localStorage.setItem('user_id', userId);
  return userId;
}

// ===== ONBOARDING TUTORIAL =====
function showOnboarding() {
  const modal = document.getElementById('buildModal');
  const codeContent = document.getElementById('codeContent');
  
  codeContent.innerHTML = `
    <div style="padding:3rem 2rem;color:#C0C7D4;max-width:800px;margin:0 auto;">
      <h2 style="color:#9333EA;margin:0 0 1rem 0;font-size:2rem;text-align:center;">üéì Welcome to SuperAgent</h2>
      <p style="color:#8A93A6;margin-bottom:2.5rem;text-align:center;font-size:1.1rem;">The #1 AI development platform with 99% accuracy</p>
      
      <div style="display:grid;gap:1.5rem;">
        <!-- Step 1 -->
        <div style="background:linear-gradient(135deg,rgba(147,51,234,0.1),rgba(168,85,247,0.1));padding:1.5rem;border-radius:0.75rem;border-left:4px solid #9333EA;">
          <h3 style="color:#C0C7D4;margin:0 0 0.75rem 0;display:flex;align-items:center;gap:0.5rem;">
            <span style="background:#9333EA;width:2rem;height:2rem;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;">1</span>
            Describe Your App
          </h3>
          <p style="color:#8A93A6;margin:0;line-height:1.6;">Simply type what you want to build in natural language. SuperAgent understands complex requirements and generates production-ready code.</p>
        </div>
        
        <!-- Step 2 -->
        <div style="background:linear-gradient(135deg,rgba(16,185,129,0.1),rgba(52,211,153,0.1));padding:1.5rem;border-radius:0.75rem;border-left:4px solid #10B981;">
          <h3 style="color:#C0C7D4;margin:0 0 0.75rem 0;display:flex;align-items:center;gap:0.5rem;">
            <span style="background:#10B981;width:2rem;height:2rem;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;">2</span>
            99% Accuracy Verification
          </h3>
          <p style="color:#8A93A6;margin:0;line-height:1.6;">Your code goes through our advanced verification system with 4 AI Supervisors running parallel analysis to catch bugs before deployment.</p>
        </div>
        
        <!-- Step 3 -->
        <div style="background:linear-gradient(135deg,rgba(59,130,246,0.1),rgba(96,165,250,0.1));padding:1.5rem;border-radius:0.75rem;border-left:4px solid #3B82F6;">
          <h3 style="color:#C0C7D4;margin:0 0 0.75rem 0;display:flex;align-items:center;gap:0.5rem;">
            <span style="background:#3B82F6;width:2rem;height:2rem;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;">3</span>
            Deploy with Confidence
          </h3>
          <p style="color:#8A93A6;margin:0;line-height:1.6;">Deploy to 8 platforms with one click. Your production apps are monitored for optimal performance and reliability.</p>
        </div>
      </div>
      
      <div style="background:#1C1F2B;padding:1.5rem;border-radius:0.75rem;margin-top:2rem;border:1px solid rgba(147,51,234,0.3);">
        <h3 style="color:#9333EA;margin:0 0 1rem 0;">‚å®Ô∏è Keyboard Shortcuts</h3>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem;">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <span style="color:#8A93A6;">Start Building</span>
            <kbd style="background:rgba(147,51,234,0.2);border:1px solid rgba(147,51,234,0.4);padding:0.25rem 0.5rem;border-radius:0.25rem;color:#C0C7D4;">Cmd+Enter</kbd>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <span style="color:#8A93A6;">Quick Search</span>
            <kbd style="background:rgba(147,51,234,0.2);border:1px solid rgba(147,51,234,0.4);padding:0.25rem 0.5rem;border-radius:0.25rem;color:#C0C7D4;">Cmd+K</kbd>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <span style="color:#8A93A6;">Show Tutorial</span>
            <kbd style="background:rgba(147,51,234,0.2);border:1px solid rgba(147,51,234,0.4);padding:0.25rem 0.5rem;border-radius:0.25rem;color:#C0C7D4;">?</kbd>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <span style="color:#8A93A6;">Why SuperAgent?</span>
            <kbd style="background:rgba(147,51,234,0.2);border:1px solid rgba(147,51,234,0.4);padding:0.25rem 0.5rem;border-radius:0.25rem;color:#C0C7D4;">Cmd+I</kbd>
          </div>
        </div>
      </div>
      
      <div style="text-align:center;margin-top:2rem;">
        <button onclick="closeModal()" style="background:linear-gradient(135deg,#9333EA,#A855F7);color:white;border:none;padding:0.75rem 2rem;border-radius:0.5rem;cursor:pointer;font-weight:700;font-size:1rem;box-shadow:0 4px 12px rgba(147,51,234,0.4);">
          Got it, let's build! üöÄ
        </button>
      </div>
      
      <p style="color:#6B7280;text-align:center;margin-top:1.5rem;font-size:0.85rem;">
        Press <kbd style="background:rgba(147,51,234,0.2);padding:0.15rem 0.4rem;border-radius:0.25rem;color:#C0C7D4;">ESC</kbd> to close
      </p>
    </div>
  `;
  
  modal.style.cssText = 'display: flex !important;';
  modal.classList.add('active');
}

// ===== COMPARISON MODAL =====
function showComparison() {
  const modal = document.getElementById('buildModal');
  const codeContent = document.getElementById('codeContent');
  
  codeContent.innerHTML = `
    <div style="padding:2rem;color:#C0C7D4;overflow-y:auto;height:100%;">
      <h2 style="color:#9333EA;margin:0 0 0.5rem 0;font-size:2rem;text-align:center;">‚ö° Why SuperAgent is #1</h2>
      <p style="color:#8A93A6;margin-bottom:2rem;text-align:center;">Feature comparison with market leaders</p>
      
      <div style="overflow-x:auto;">
        <table style="width:100%;border-collapse:separate;border-spacing:0;border:1px solid rgba(147,51,234,0.2);border-radius:0.75rem;overflow:hidden;">
          <thead>
            <tr style="background:linear-gradient(135deg,rgba(147,51,234,0.2),rgba(168,85,247,0.2));">
              <th style="padding:1rem;text-align:left;border-bottom:1px solid rgba(147,51,234,0.2);color:#C0C7D4;font-weight:700;">Feature</th>
              <th style="padding:1rem;text-align:center;border-bottom:1px solid rgba(147,51,234,0.2);border-left:1px solid rgba(147,51,234,0.2);color:#9333EA;font-weight:700;">SuperAgent</th>
              <th style="padding:1rem;text-align:center;border-bottom:1px solid rgba(147,51,234,0.2);border-left:1px solid rgba(147,51,234,0.2);color:#8A93A6;">Cursor</th>
              <th style="padding:1rem;text-align:center;border-bottom:1px solid rgba(147,51,234,0.2);border-left:1px solid rgba(147,51,234,0.2);color:#8A93A6;">Devin</th>
              <th style="padding:1rem;text-align:center;border-bottom:1px solid rgba(147,51,234,0.2);border-left:1px solid rgba(147,51,234,0.2);color:#8A93A6;">Replit Agent</th>
            </tr>
          </thead>
          <tbody>
            <tr style="background:rgba(13,15,19,0.3);">
              <td style="padding:0.75rem;border-bottom:1px solid rgba(147,51,234,0.1);color:#8A93A6;">Code Verification</td>
              <td style="padding:0.75rem;text-align:center;border-bottom:1px solid rgba(147,51,234,0.1);border-left:1px solid rgba(147,51,234,0.1);color:#10B981;font-weight:700;">‚úÖ 99%</td>
              <td style="padding:0.75rem;text-align:center;border-bottom:1px solid rgba(147,51,234,0.1);border-left:1px solid rgba(147,51,234,0.1);color:#EF4444;">‚ùå</td>
              <td style="padding:0.75rem;text-align:center;border-bottom:1px solid rgba(147,51,234,0.1);border-left:1px solid rgba(147,51,234,0.1);color:#EF4444;">‚ùå</td>
              <td style="padding:0.75rem;text-align:center;border-bottom:1px solid rgba(147,51,234,0.1);border-left:1px solid rgba(147,51,234,0.1);color:#EF4444;">‚ùå</td>
            </tr>
            <tr>
              <td style="padding:0.75rem;border-bottom:1px solid rgba(147,51,234,0.1);color:#8A93A6;">Enterprise Security</td>
              <td style="padding:0.75rem;text-align:center;border-bottom:1px solid rgba(147,51,234,0.1);border-left:1px solid rgba(147,51,234,0.1);color:#10B981;font-weight:700;">‚úÖ</td>
              <td style="padding:0.75rem;text-align:center;border-bottom:1px solid rgba(147,51,234,0.1);border-left:1px solid rgba(147,51,234,0.1);color:#F59E0B;">‚ö†Ô∏è</td>
              <td style="padding:0.75rem;text-align:center;border-bottom:1px solid rgba(147,51,234,0.1);border-left:1px solid rgba(147,51,234,0.1);color:#EF4444;">‚ùå</td>
              <td style="padding:0.75rem;text-align:center;border-bottom:1px solid rgba(147,51,234,0.1);border-left:1px solid rgba(147,51,234,0.1);color:#F59E0B;">‚ö†Ô∏è</td>
            </tr>
            <tr>
              <td style="padding:0.75rem;border-bottom:1px solid rgba(147,51,234,0.1);color:#8A93A6;">Multi-Provider AI</td>
              <td style="padding:0.75rem;text-align:center;border-bottom:1px solid rgba(147,51,234,0.1);border-left:1px solid rgba(147,51,234,0.1);color:#10B981;font-weight:700;">‚úÖ 4 Providers</td>
              <td style="padding:0.75rem;text-align:center;border-bottom:1px solid rgba(147,51,234,0.1);border-left:1px solid rgba(147,51,234,0.1);color:#F59E0B;">‚ö†Ô∏è</td>
              <td style="padding:0.75rem;text-align:center;border-bottom:1px solid rgba(147,51,234,0.1);border-left:1px solid rgba(147,51,234,0.1);color:#EF4444;">‚ùå</td>
              <td style="padding:0.75rem;text-align:center;border-bottom:1px solid rgba(147,51,234,0.1);border-left:1px solid rgba(147,51,234,0.1);color:#EF4444;">‚ùå</td>
            </tr>
            <tr style="background:rgba(13,15,19,0.3);">
              <td style="padding:0.75rem;border-bottom:1px solid rgba(147,51,234,0.1);color:#8A93A6;">Multiplayer Coding</td>
              <td style="padding:0.75rem;text-align:center;border-bottom:1px solid rgba(147,51,234,0.1);border-left:1px solid rgba(147,51,234,0.1);color:#10B981;font-weight:700;">‚úÖ</td>
              <td style="padding:0.75rem;text-align:center;border-bottom:1px solid rgba(147,51,234,0.1);border-left:1px solid rgba(147,51,234,0.1);color:#EF4444;">‚ùå</td>
              <td style="padding:0.75rem;text-align:center;border-bottom:1px solid rgba(147,51,234,0.1);border-left:1px solid rgba(147,51,234,0.1);color:#EF4444;">‚ùå</td>
              <td style="padding:0.75rem;text-align:center;border-bottom:1px solid rgba(147,51,234,0.1);border-left:1px solid rgba(147,51,234,0.1);color:#10B981;">‚úÖ</td>
            </tr>
            <tr>
              <td style="padding:0.75rem;border-bottom:1px solid rgba(147,51,234,0.1);color:#8A93A6;">Extended Thinking</td>
              <td style="padding:0.75rem;text-align:center;border-bottom:1px solid rgba(147,51,234,0.1);border-left:1px solid rgba(147,51,234,0.1);color:#10B981;font-weight:700;">‚úÖ</td>
              <td style="padding:0.75rem;text-align:center;border-bottom:1px solid rgba(147,51,234,0.1);border-left:1px solid rgba(147,51,234,0.1);color:#EF4444;">‚ùå</td>
              <td style="padding:0.75rem;text-align:center;border-bottom:1px solid rgba(147,51,234,0.1);border-left:1px solid rgba(147,51,234,0.1);color:#EF4444;">‚ùå</td>
              <td style="padding:0.75rem;text-align:center;border-bottom:1px solid rgba(147,51,234,0.1);border-left:1px solid rgba(147,51,234,0.1);color:#EF4444;">‚ùå</td>
            </tr>
            <tr style="background:rgba(13,15,19,0.3);">
              <td style="padding:0.75rem;border-bottom:1px solid rgba(147,51,234,0.1);color:#8A93A6;font-weight:700;">Price</td>
              <td style="padding:0.75rem;text-align:center;border-bottom:1px solid rgba(147,51,234,0.1);border-left:1px solid rgba(147,51,234,0.1);color:#10B981;font-weight:700;">FREE üéâ</td>
              <td style="padding:0.75rem;text-align:center;border-bottom:1px solid rgba(147,51,234,0.1);border-left:1px solid rgba(147,51,234,0.1);color:#F59E0B;">$20-200/mo</td>
              <td style="padding:0.75rem;text-align:center;border-bottom:1px solid rgba(147,51,234,0.1);border-left:1px solid rgba(147,51,234,0.1);color:#EF4444;">$500/mo</td>
              <td style="padding:0.75rem;text-align:center;border-bottom:1px solid rgba(147,51,234,0.1);border-left:1px solid rgba(147,51,234,0.1);color:#F59E0B;">$25-35/mo</td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <div style="background:linear-gradient(135deg,rgba(16,185,129,0.1),rgba(52,211,153,0.1));padding:1.5rem;border-radius:0.75rem;margin-top:2rem;border:1px solid #10B981;">
        <h3 style="color:#10B981;margin:0 0 0.75rem 0;font-size:1.25rem;">üèÜ SuperAgent Advantages</h3>
        <ul style="margin:0;padding-left:1.5rem;line-height:1.8;color:#8A93A6;">
          <li><strong style="color:#C0C7D4;">99% Accuracy:</strong> Advanced verification pipeline catches 99% of bugs before deployment</li>
          <li><strong style="color:#C0C7D4;">Enterprise Security:</strong> Production-grade security scanning and validation</li>
          <li><strong style="color:#C0C7D4;">Completely FREE:</strong> Just bring your own API keys</li>
          <li><strong style="color:#C0C7D4;">4 AI Providers:</strong> Gemini, Claude, OpenAI, Groq - your choice</li>
          <li><strong style="color:#C0C7D4;">Extended Thinking:</strong> Multi-step reasoning for complex problems</li>
        </ul>
      </div>
      
      <div style="text-align:center;margin-top:2rem;">
        <button onclick="closeModal()" style="background:linear-gradient(135deg,#9333EA,#A855F7);color:white;border:none;padding:0.75rem 2rem;border-radius:0.5rem;cursor:pointer;font-weight:700;font-size:1rem;box-shadow:0 4px 12px rgba(147,51,234,0.4);">
          Start Building with SuperAgent üöÄ
        </button>
      </div>
    </div>
  `;
  
  modal.style.cssText = 'display: flex !important;';
  modal.classList.add('active');
}

function showPricing() {
  const modal = document.getElementById('buildModal');
  const codeContent = document.getElementById('codeContent');
  
  codeContent.innerHTML = `
    <div style="padding:2rem;color:#C0C7D4;overflow-y:auto;height:100%;">
      <h2 style="color:#9333EA;margin:0 0 0.5rem 0;font-size:2rem;text-align:center;">üí∞ Simple, Transparent Pricing</h2>
      <p style="color:#8A93A6;margin-bottom:2rem;text-align:center;">Choose the plan that works for you</p>
      
      <!-- Pricing Cards -->
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1.5rem;margin-bottom:2rem;">
        
        <!-- FREE TIER -->
        <div style="background:linear-gradient(135deg,rgba(35,15,42,0.6),rgba(59,30,70,0.6));border:2px solid rgba(147,51,234,0.3);border-radius:1rem;padding:1.5rem;position:relative;">
          <div style="background:linear-gradient(135deg,#10B981,#34D399);color:white;font-size:0.7rem;font-weight:700;padding:0.3rem 0.6rem;border-radius:0.5rem;position:absolute;top:-0.5rem;right:1rem;box-shadow:0 2px 8px rgba(16,185,129,0.4);">POPULAR</div>
          <h3 style="color:#C0C7D4;margin:0 0 0.5rem 0;font-size:1.5rem;">Free</h3>
          <div style="color:#9333EA;font-size:2.5rem;font-weight:700;margin:1rem 0;">$0<span style="font-size:1rem;color:#8A93A6;font-weight:400;">/mo</span></div>
          <ul style="list-style:none;padding:0;margin:1rem 0;line-height:2;">
            <li style="color:#8A93A6;">‚úÖ Unlimited projects</li>
            <li style="color:#8A93A6;">‚úÖ 99% accuracy</li>
            <li style="color:#8A93A6;">‚úÖ All core features</li>
            <li style="color:#8A93A6;">‚úÖ Bring your API keys</li>
            <li style="color:#8A93A6;">‚úÖ Community support</li>
          </ul>
          <button onclick="showNotification(isAdminUser() ? 'Admin = Unlimited Free Access! üéâ' : 'You\\'re already on Free! Start building now üöÄ', 'success')" style="width:100%;background:linear-gradient(135deg,#8A93A6,#C0C7D4);color:#0D0F13;border:none;padding:0.75rem;border-radius:0.5rem;cursor:pointer;font-weight:700;margin-top:1rem;">Current Plan</button>
        </div>
        
        <!-- PRO TIER -->
        <div style="background:linear-gradient(135deg,rgba(147,51,234,0.2),rgba(168,85,247,0.2));border:2px solid #9333EA;border-radius:1rem;padding:1.5rem;box-shadow:0 8px 24px rgba(147,51,234,0.3);">
          <h3 style="color:#F4F6FB;margin:0 0 0.5rem 0;font-size:1.5rem;">Pro</h3>
          <div style="color:#9333EA;font-size:2.5rem;font-weight:700;margin:1rem 0;">$29<span style="font-size:1rem;color:#8A93A6;font-weight:400;">/mo</span></div>
          <ul style="list-style:none;padding:0;margin:1rem 0;line-height:2;">
            <li style="color:#C0C7D4;">‚úÖ Everything in Free</li>
            <li style="color:#C0C7D4;">‚úÖ Priority AI processing</li>
            <li style="color:#C0C7D4;">‚úÖ 50 AI credits/mo included</li>
            <li style="color:#C0C7D4;">‚úÖ Advanced analytics</li>
            <li style="color:#C0C7D4;">‚úÖ Priority support</li>
          </ul>
          <button onclick="showNotification('Contact us to upgrade to Pro', 'info')" style="width:100%;background:linear-gradient(135deg,#9333EA,#A855F7);color:white;border:none;padding:0.75rem;border-radius:0.5rem;cursor:pointer;font-weight:700;margin-top:1rem;box-shadow:0 4px 12px rgba(147,51,234,0.4);">Upgrade to Pro</button>
        </div>
        
        <!-- TEAM TIER -->
        <div style="background:linear-gradient(135deg,rgba(35,15,42,0.6),rgba(59,30,70,0.6));border:2px solid rgba(147,51,234,0.3);border-radius:1rem;padding:1.5rem;">
          <h3 style="color:#C0C7D4;margin:0 0 0.5rem 0;font-size:1.5rem;">Team</h3>
          <div style="color:#9333EA;font-size:2.5rem;font-weight:700;margin:1rem 0;">$99<span style="font-size:1rem;color:#8A93A6;font-weight:400;">/mo</span></div>
          <ul style="list-style:none;padding:0;margin:1rem 0;line-height:2;">
            <li style="color:#8A93A6;">‚úÖ Everything in Pro</li>
            <li style="color:#8A93A6;">‚úÖ Up to 10 team members</li>
            <li style="color:#8A93A6;">‚úÖ 200 AI credits/mo</li>
            <li style="color:#8A93A6;">‚úÖ Real-time collaboration</li>
            <li style="color:#8A93A6;">‚úÖ Team analytics</li>
          </ul>
          <button onclick="showNotification('Contact us for Team pricing', 'info')" style="width:100%;background:linear-gradient(135deg,#8A93A6,#C0C7D4);color:#0D0F13;border:none;padding:0.75rem;border-radius:0.5rem;cursor:pointer;font-weight:700;margin-top:1rem;">Get Team Plan</button>
        </div>
        
        <!-- ENTERPRISE TIER -->
        <div style="background:linear-gradient(135deg,rgba(35,15,42,0.6),rgba(59,30,70,0.6));border:2px solid rgba(245,158,11,0.4);border-radius:1rem;padding:1.5rem;">
          <h3 style="color:#F59E0B;margin:0 0 0.5rem 0;font-size:1.5rem;">Enterprise</h3>
          <div style="color:#F59E0B;font-size:2.5rem;font-weight:700;margin:1rem 0;">$299<span style="font-size:1rem;color:#8A93A6;font-weight:400;">/mo</span></div>
          <ul style="list-style:none;padding:0;margin:1rem 0;line-height:2;">
            <li style="color:#8A93A6;">‚úÖ Everything in Team</li>
            <li style="color:#8A93A6;">‚úÖ Unlimited team members</li>
            <li style="color:#8A93A6;">‚úÖ Unlimited AI credits</li>
            <li style="color:#8A93A6;">‚úÖ Custom integrations</li>
            <li style="color:#8A93A6;">‚úÖ Dedicated support</li>
          </ul>
          <button onclick="showNotification('Contact sales@superagent.dev', 'info')" style="width:100%;background:linear-gradient(135deg,#F59E0B,#EF4444);color:white;border:none;padding:0.75rem;border-radius:0.5rem;cursor:pointer;font-weight:700;margin-top:1rem;">Contact Sales</button>
        </div>
        
      </div>
      
      <!-- Payment Methods -->
      <div style="background:linear-gradient(135deg,rgba(147,51,234,0.1),rgba(168,85,247,0.1));padding:1.5rem;border-radius:0.75rem;border:1px solid rgba(147,51,234,0.3);margin-bottom:2rem;">
        <h3 style="color:#9333EA;margin:0 0 1rem 0;font-size:1.25rem;text-align:center;">üí≥ We Accept Multiple Payment Methods</h3>
        <div style="display:flex;justify-content:center;align-items:center;gap:2rem;flex-wrap:wrap;">
          <div style="text-align:center;">
            <div style="font-size:2rem;margin-bottom:0.25rem;">‚Çø</div>
            <div style="color:#8A93A6;font-size:0.875rem;font-weight:600;">Crypto</div>
          </div>
          <div style="text-align:center;">
            <div style="font-size:2rem;margin-bottom:0.25rem;">üíµ</div>
            <div style="color:#8A93A6;font-size:0.875rem;font-weight:600;">Zelle</div>
          </div>
          <div style="text-align:center;">
            <div style="font-size:2rem;margin-bottom:0.25rem;">üí∏</div>
            <div style="color:#8A93A6;font-size:0.875rem;font-weight:600;">CashApp</div>
          </div>
          <div style="text-align:center;">
            <div style="font-size:2rem;margin-bottom:0.25rem;">üÖøÔ∏è</div>
            <div style="color:#8A93A6;font-size:0.875rem;font-weight:600;">PayPal</div>
          </div>
        </div>
        <p style="text-align:center;color:#8A93A6;margin-top:1rem;font-size:0.875rem;">All transactions are secure and encrypted. Contact us for payment details.</p>
      </div>
      
      <!-- FAQ -->
      <div style="background:rgba(13,15,19,0.4);padding:1.5rem;border-radius:0.75rem;border:1px solid rgba(138,147,166,0.2);">
        <h3 style="color:#C0C7D4;margin:0 0 1rem 0;font-size:1.25rem;">‚ùì Frequently Asked Questions</h3>
        <div style="line-height:1.8;color:#8A93A6;">
          <p><strong style="color:#C0C7D4;">Can I switch plans anytime?</strong><br>Yes! Upgrade or downgrade at any time. No long-term contracts.</p>
          <p><strong style="color:#C0C7D4;">What are AI credits?</strong><br>Credits cover API costs for Gemini, Claude, OpenAI, and Groq. Free tier uses your own API keys.</p>
          <p><strong style="color:#C0C7D4;">Is there a free trial?</strong><br>The Free plan is forever free with unlimited projects! No credit card required.</p>
          <p><strong style="color:#C0C7D4;">Need custom pricing?</strong><br>Contact us for volume discounts, educational licenses, or custom enterprise plans.</p>
        </div>
      </div>
      
      <div style="text-align:center;margin-top:2rem;">
        <button onclick="closeModal()" style="background:linear-gradient(135deg,#8A93A6,#C0C7D4);color:#0D0F13;border:none;padding:0.75rem 2rem;border-radius:0.5rem;cursor:pointer;font-weight:700;font-size:1rem;">
          Close
        </button>
      </div>
    </div>
  `;
  
  modal.style.cssText = 'display: flex !important;';
  modal.classList.add('active');
}

// ===== KEYBOARD SHORTCUTS =====
document.addEventListener('keydown', (e) => {
  // Cmd/Ctrl + Enter = Start Building
  if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') {
    e.preventDefault();
    const startBtn = document.querySelector('.start-btn');
    if (startBtn && !startBtn.disabled) {
      startBtn.click();
    }
  }
  
  // Cmd/Ctrl + K = Quick search (future feature)
  if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
    e.preventDefault();
    showNotification('Quick search coming soon!', 'info');
  }
  
  // Cmd/Ctrl + I = Show comparison
  if ((e.metaKey || e.ctrlKey) && e.key === 'i') {
    e.preventDefault();
    showComparison();
  }
  
  // ? = Show tutorial
  if (e.key === '?' && !e.metaKey && !e.ctrlKey && !e.altKey) {
    const activeElement = document.activeElement;
    if (activeElement.tagName !== 'INPUT' && activeElement.tagName !== 'TEXTAREA') {
      e.preventDefault();
      showOnboarding();
    }
  }
  
  // ESC = Close modal
  if (e.key === 'Escape') {
    closeModal();
  }
});

// Show keyboard hint on first visit
if (!localStorage.getItem('keyboard_hint_shown')) {
  setTimeout(() => {
    const hint = document.createElement('div');
    hint.className = 'kbd-hint';
    hint.innerHTML = 'Press <span class="kbd">?</span> for tutorial or <span class="kbd">Cmd+I</span> to see why we\'re #1';
    document.body.appendChild(hint);
    
    setTimeout(() => hint.remove(), 8000);
    localStorage.setItem('keyboard_hint_shown', 'true');
  }, 3000);
}

// ===== SELF-REPAIR SYSTEM =====
async function showSelfRepairStatus() {
  const modal = document.getElementById('buildModal');
  const codeContent = document.getElementById('codeContent');
  
  try {
    const healthResponse = await fetch('/self-repair/health');
    const healthData = await healthResponse.json();
    
    const errorsResponse = await fetch('/self-repair/errors');
    const errorsData = await errorsResponse.json();
    
    const repairsResponse = await fetch('/self-repair/repairs');
    const repairsData = await repairsResponse.json();
    
    const statusColor = healthData.status === 'healthy' ? '#10B981' : healthData.status === 'critical' ? '#EF4444' : '#F59E0B';
    const statusText = healthData.status === 'healthy' ? 'Healthy' : healthData.status === 'critical' ? 'Critical' : 'Warning';
    
    codeContent.innerHTML = `
      <div style="padding:2rem;color:#C0C7D4;overflow-y:auto;height:100%;">
        <h2 style="color:#10B981;margin:0 0 1rem 0;">üîß Self-Repair System</h2>
        <p style="color:#8A93A6;margin-bottom:2rem;">Autonomous error detection and auto-fixing</p>
        
        <!-- Status -->
        <div style="background:linear-gradient(135deg,rgba(16,185,129,0.1),rgba(52,211,153,0.1));padding:1.5rem;border-radius:0.75rem;border:1px solid ${statusColor};margin-bottom:1.5rem;">
          <div style="display:flex;align-items:center;justify-content:space-between;">
            <div>
              <h3 style="color:${statusColor};margin:0 0 0.5rem 0;">System Status: ${statusText}</h3>
              <p style="color:#8A93A6;font-size:0.85rem;margin:0;">
                Monitoring: <span style="color:${healthData.monitoring_active ? '#10B981' : '#8A93A6'}">${healthData.monitoring_active ? 'Active' : 'Inactive'}</span>
              </p>
            </div>
            <button onclick="toggleMonitoring(${healthData.monitoring_active})" 
              style="background:${healthData.monitoring_active ? '#EF4444' : '#10B981'};color:white;border:none;padding:0.5rem 1rem;border-radius:0.5rem;cursor:pointer;font-weight:600;">
              ${healthData.monitoring_active ? 'Stop' : 'Start'} Monitoring
            </button>
          </div>
        </div>
        
        <!-- Stats -->
        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:1rem;margin-bottom:1.5rem;">
          <div style="background:#1C1F2B;padding:1rem;border-radius:0.5rem;">
            <div style="color:#8A93A6;font-size:0.75rem;margin-bottom:0.25rem;">Errors (Last Hour)</div>
            <div style="color:#C0C7D4;font-size:1.5rem;font-weight:700;">${healthData.total_errors_last_hour}</div>
          </div>
          <div style="background:#1C1F2B;padding:1rem;border-radius:0.5rem;">
            <div style="color:#8A93A6;font-size:0.75rem;margin-bottom:0.25rem;">Critical Errors</div>
            <div style="color:${healthData.critical_errors > 0 ? '#EF4444' : '#10B981'};font-size:1.5rem;font-weight:700;">${healthData.critical_errors}</div>
          </div>
          <div style="background:#1C1F2B;padding:1rem;border-radius:0.5rem;">
            <div style="color:#8A93A6;font-size:0.75rem;margin-bottom:0.25rem;">Total Repairs</div>
            <div style="color:#34D399;font-size:1.5rem;font-weight:700;">${healthData.total_repairs}</div>
          </div>
          <div style="background:#1C1F2B;padding:1rem;border-radius:0.5rem;">
            <div style="color:#8A93A6;font-size:0.75rem;margin-bottom:0.25rem;">Success Rate</div>
            <div style="color:#10B981;font-size:1.5rem;font-weight:700;">${healthData.success_rate.toFixed(0)}%</div>
          </div>
        </div>
        
        <!-- Actions -->
        <div style="margin-bottom:1.5rem;">
          <button onclick="runSelfRepairScan()" 
            style="width:100%;background:linear-gradient(135deg,#10B981,#34D399);color:white;border:none;padding:0.75rem;border-radius:0.5rem;cursor:pointer;font-weight:700;">
            üîç Scan & Auto-Repair Now
          </button>
        </div>
        
        <!-- Recent Errors -->
        <div style="background:#1C1F2B;padding:1.5rem;border-radius:0.75rem;margin-bottom:1.5rem;">
          <h3 style="color:#9333EA;margin:0 0 1rem 0;">Recent Errors (${errorsData.total_errors})</h3>
          ${errorsData.errors.length > 0 ? errorsData.errors.slice(0,5).map(err => `
            <div style="background:#0D0F13;padding:1rem;border-radius:0.5rem;margin-bottom:0.75rem;border-left:3px solid ${err.severity === 'critical' ? '#EF4444' : err.severity === 'high' ? '#F59E0B' : '#8A93A6'};">
              <div style="color:#C0C7D4;font-weight:600;margin-bottom:0.25rem;">${err.type}</div>
              <div style="color:#8A93A6;font-size:0.85rem;margin-bottom:0.5rem;">${err.message.substring(0,80)}...</div>
              <div style="display:flex;gap:1rem;font-size:0.75rem;color:#6B7280;">
                <span>Severity: ${err.severity}</span>
                <span>Auto-fixable: ${err.auto_fixable ? '‚úÖ' : '‚ùå'}</span>
              </div>
            </div>
          `).join('') : '<p style="color:#8A93A6;font-size:0.85rem;">No errors detected</p>'}
        </div>
        
        <!-- Recent Repairs -->
        <div style="background:#1C1F2B;padding:1.5rem;border-radius:0.75rem;">
          <h3 style="color:#10B981;margin:0 0 1rem 0;">Recent Repairs (${repairsData.total_repairs})</h3>
          ${repairsData.repairs.length > 0 ? repairsData.repairs.slice(0,5).map(repair => `
            <div style="background:#0D0F13;padding:1rem;border-radius:0.5rem;margin-bottom:0.75rem;border-left:3px solid ${repair.success ? '#10B981' : '#EF4444'};">
              <div style="color:#C0C7D4;font-weight:600;margin-bottom:0.25rem;">${repair.action_type}</div>
              <div style="color:#8A93A6;font-size:0.85rem;margin-bottom:0.5rem;">${repair.description}</div>
              <div style="color:${repair.success ? '#10B981' : '#EF4444'};font-size:0.75rem;">
                ${repair.success ? '‚úÖ Fixed successfully' : '‚ùå Fix failed'}
              </div>
            </div>
          `).join('') : '<p style="color:#8A93A6;font-size:0.85rem;">No repairs performed yet</p>'}
        </div>
      </div>
    `;
    
    modal.style.cssText = 'display: flex !important;';
    modal.classList.add('active');
    
  } catch (error) {
    showNotification('Failed to load self-repair status', 'error');
  }
}

async function toggleMonitoring(currentStatus) {
  try {
    const endpoint = currentStatus ? '/self-repair/monitor/stop' : '/self-repair/monitor/start';
    const response = await fetch(endpoint, { method: 'POST' });
    const data = await response.json();
    
    if (data.success) {
      showNotification(data.message, 'success');
      showSelfRepairStatus(); // Refresh
    }
  } catch (error) {
    showNotification('Failed to toggle monitoring', 'error');
  }
}

async function runSelfRepairScan() {
  try {
    showNotification('Running self-repair scan...', 'info');
    
    const response = await fetch('/self-repair/scan', { method: 'POST' });
    const data = await response.json();
    
    if (data.success) {
      showNotification(
        `Scan complete: ${data.errors_detected} errors found, ${data.repairs_successful}/${data.repairs_attempted} fixed`,
        data.repairs_successful > 0 ? 'success' : 'info'
      );
      showSelfRepairStatus(); // Refresh
    } else {
      showNotification('Scan failed: ' + (data.error || 'Unknown error'), 'error');
    }
  } catch (error) {
    showNotification('Failed to run scan', 'error');
  }
}

// ========== STREAMING CONVERSATIONAL PLANNING (Like Replit Agent) ==========

let conversationContext = {};
let conversationActive = false;
let currentEventSource = null;
let currentStreamingMessageId = null;

// Start streaming plan response
async function streamPlan(planId) {
  const messagesContainer = document.getElementById('conversationMessages');
  
  // Create a new message div for streaming content
  const messageDiv = document.createElement('div');
  messageDiv.id = 'streaming-message';
  currentStreamingMessageId = 'streaming-message';
  messageDiv.style.marginBottom = '1rem';
  messageDiv.innerHTML = `
    <div style="display:flex;align-items:start;gap:0.75rem;margin-bottom:1rem;">
      <div style="width:1.75rem;height:1.75rem;background:linear-gradient(135deg,#8A93A6,#C0C7D4);border-radius:50%;display:flex;align-items:center;justify-content:center;color:#0D0F13;font-weight:700;font-size:0.85rem;flex-shrink:0;">AI</div>
      <div id="streaming-content" style="flex:1;color:#C0C7D4;font-size:0.95rem;line-height:1.8;"></div>
    </div>
  `;
  messagesContainer.appendChild(messageDiv);
  
  const streamingContent = document.getElementById('streaming-content');
  
  // Connect to SSE endpoint
  currentEventSource = new EventSource(`/plan/stream/${planId}`);
  
  currentEventSource.onmessage = (event) => {
    try {
      const data = JSON.parse(event.data);
      
      if (data.type === 'chunk') {
        // Append streaming content token by token (like Replit Agent)
        streamingContent.innerHTML += data.content.replace(/\n/g, '<br>');
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      } else if (data.type === 'complete') {
        // Plan is complete - show approval buttons
        currentEventSource.close();
        currentEventSource = null;
        
        // CRITICAL: Set conversation status to allow revisions
        conversationContext.status = 'planned';
        conversationContext.planId = planId;
        
        // Add approval controls below plan
        const controlsDiv = document.createElement('div');
        controlsDiv.style.cssText = 'margin:1rem 0 0 2.5rem;display:flex;gap:0.75rem;';
        controlsDiv.innerHTML = `
          <button onclick="revisePlan('${planId}')" style="flex:1;background:linear-gradient(135deg,#9333EA,#7C3AED);color:white;border:none;padding:0.75rem 1rem;border-radius:0.6rem;cursor:pointer;font-weight:600;">üí¨ Revise Plan</button>
          <button onclick="approvePlanAndBuild('${planId}')" style="flex:1;background:linear-gradient(135deg,#10B981,#34D399);color:white;border:none;padding:0.75rem 1rem;border-radius:0.6rem;cursor:pointer;font-weight:700;">‚úÖ Looks Good, Build It!</button>
        `;
        messagesContainer.appendChild(controlsDiv);
        
        // Update input placeholder
        const ideaInput = document.getElementById('ideaInput');
        ideaInput.placeholder = 'Ask questions, request changes, or click "Build It" when ready...';
        ideaInput.value = '';
        
        showNotification('üí¨ Plan ready! Review and approve to build, or ask for changes.', 'success');
        buildInProgress = false;
      } else if (data.type === 'error') {
        currentEventSource.close();
        currentEventSource = null;
        streamingContent.innerHTML += `<br><span style="color:#EF4444;">‚ùå Error: ${data.message}</span>`;
      }
    } catch (e) {
      console.error('Error parsing SSE data:', e);
    }
  };
  
  currentEventSource.onerror = () => {
    if (currentEventSource) {
      currentEventSource.close();
      currentEventSource = null;
    }
  };
}

// Add message inline (for user messages and thinking states)
function addInlineMessage(role, content, type = 'text') {
  const messagesContainer = document.getElementById('conversationMessages');
  messagesContainer.style.display = 'block';
  
  const messageDiv = document.createElement('div');
  messageDiv.style.marginBottom = '1rem';
  
  if (role === 'user') {
    messageDiv.innerHTML = `
      <div style="display:flex;align-items:start;gap:0.75rem;margin-bottom:1rem;">
        <div style="width:1.75rem;height:1.75rem;background:linear-gradient(135deg,#9333EA,#7C3AED);border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:0.85rem;flex-shrink:0;">U</div>
        <div style="flex:1;color:#E0E4EA;font-size:0.95rem;line-height:1.6;padding-top:0.25rem;">${content}</div>
      </div>
    `;
  } else if (type === 'thinking') {
    messageDiv.innerHTML = `
      <div style="display:flex;align-items:center;gap:0.75rem;margin:0.75rem 0;">
        <div style="width:1.75rem;height:1.75rem;background:linear-gradient(135deg,#10B981,#34D399);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1rem;flex-shrink:0;">‚ö°</div>
        <div style="color:#10B981;font-size:0.85rem;font-style:italic;">${content}</div>
      </div>
    `;
  }
  
  messagesContainer.appendChild(messageDiv);
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// Revise plan - allow user to ask for changes
async function revisePlan(planId) {
  const ideaInput = document.getElementById('ideaInput');
  ideaInput.value = '';
  ideaInput.placeholder = 'What would you like to change or add to the plan?';
  ideaInput.focus();
  
  // Store plan_id for continuing conversation
  conversationContext.planId = planId;
  conversationContext.status = 'revising';
  
  showNotification('üí¨ Type your feedback or requested changes', 'info');
}

// Copy code to clipboard helper
function copyCodeToClipboard(button) {
  const code = button.getAttribute('data-code').replace(/&quot;/g, '"');
  navigator.clipboard.writeText(code).then(() => {
    button.textContent = '‚úì Copied!';
    setTimeout(() => button.textContent = 'Copy', 2000);
  });
}

// Approve plan and start building
async function approvePlanAndBuild(planId) {
  try {
    addInlineProgress('Approving plan and starting build...');
    
    // Approve the plan
    const approveResponse = await fetch(`/plan/approve/${planId}`, {
      method: 'POST',
      headers: getAuthHeaders()
    });
    
    if (!approveResponse.ok) throw new Error('Failed to approve plan');
    const approveData = await approveResponse.json();
    
    // Show build progress
    addInlineTaskList([
      { content: 'Generating code', status: 'in_progress' },
      { content: 'Installing dependencies', status: 'pending' },
      { content: 'Running tests', status: 'pending' },
      { content: 'Creating deployment config', status: 'pending' }
    ]);
    
    // Build using the approved plan
    const enterpriseModeEnabled = document.getElementById('enterpriseModeToggle').checked;
    const endpoint = enterpriseModeEnabled ? '/enterprise-build' : '/build';
    
    const buildResponse = await fetch(endpoint, {
      method: 'POST',
      headers: getAuthHeaders(),
      body: JSON.stringify({
        instruction: approveData.instruction,
        language: conversationContext.language || 'python',
        ...(enterpriseModeEnabled && {
          enable_checkpoints: true,
          enable_testing: true,
          enable_security_scan: true,
          enable_multi_file: true
        })
      })
    });
    
    if (!buildResponse.ok) throw new Error('Build failed');
    const buildData = await buildResponse.json();
    
    addInlineProgress('‚úÖ Build complete!');
    
    // Show results
    const resultMessage = enterpriseModeEnabled ?
      `üè¢ <strong>Enterprise Build Complete!</strong><br><br>üìÅ Project: ${buildData.project_dir}<br>üìÑ Files: ${buildData.files_created?.length || 0}<br>‚úÖ Tests: ${buildData.tests_passed || 0} passed` :
      `‚úÖ <strong>Build Complete!</strong><br><br>üìÅ Your app is ready!`;
    
    const resultDiv = document.createElement('div');
    resultDiv.style.cssText = 'margin:1rem 0 1rem 2.5rem;padding:1rem;background:rgba(16,185,129,.1);border-left:3px solid #10B981;border-radius:0.5rem;color:#C0C7D4;';
    resultDiv.innerHTML = resultMessage;
    document.getElementById('conversationMessages').appendChild(resultDiv);
    
    // Show code INLINE (no modal - keep everything on one page like Replit Agent)
    const codeContent = buildData.code || buildData.code_preview || buildData.message;
    const codeDiv = document.createElement('div');
    codeDiv.style.cssText = 'margin:1rem 0 1rem 2.5rem;background:#0D0F13;border:1px solid rgba(147,51,234,.3);border-radius:0.75rem;overflow:hidden;';
    codeDiv.innerHTML = `
      <div style="padding:0.75rem 1rem;background:rgba(35,15,42,0.5);border-bottom:1px solid rgba(147,51,234,.2);display:flex;justify-content:space-between;align-items:center;">
        <span style="color:#9333EA;font-weight:600;font-size:0.9rem;">üìÑ Generated Code</span>
        <button onclick="copyCodeToClipboard(this)" data-code="${codeContent.replace(/"/g, '&quot;')}" style="background:rgba(147,51,234,.2);border:1px solid rgba(147,51,234,.3);color:#9333EA;padding:0.4rem 0.8rem;border-radius:0.5rem;cursor:pointer;font-size:0.8rem;">Copy</button>
      </div>
      <pre style="margin:0;padding:1rem;color:#C0C7D4;font-size:0.85rem;line-height:1.6;max-height:400px;overflow-y:auto;"><code>${escapeHtml(codeContent)}</code></pre>
    `;
    document.getElementById('conversationMessages').appendChild(codeDiv);
    
    showNotification('Build completed successfully!', 'success');
    
    // Reset conversation
    conversationActive = false;
    conversationContext = {};
    
  } catch (error) {
    const errDiv = document.createElement('div');
    errDiv.style.cssText = 'margin:1rem 0 1rem 2.5rem;color:#EF4444;';
    errDiv.innerHTML = `‚ùå Build failed: ${error.message}`;
    document.getElementById('conversationMessages').appendChild(errDiv);
    showNotification('Build failed', 'error');
  }
}

// Add inline task list
function addInlineTaskList(tasks) {
  const messagesContainer = document.getElementById('conversationMessages');
  const taskListDiv = document.createElement('div');
  taskListDiv.style.cssText = 'background:rgba(147,51,234,.15);border-left:3px solid #9333EA;padding:1rem;border-radius:0.5rem;margin:0.75rem 0 0.75rem 2.5rem;';
  
  let taskHTML = '<div style="color:#9333EA;font-weight:700;margin-bottom:0.75rem;font-size:0.95rem;">üìã Tasks</div>';
  tasks.forEach((task) => {
    const icon = task.status === 'completed' ? '‚úÖ' : task.status === 'in_progress' ? '‚è≥' : '‚¨ú';
    taskHTML += `
      <div style="display:flex;align-items:center;gap:0.5rem;margin:0.5rem 0;color:#C0C7D4;font-size:0.875rem;">
        <span>${icon}</span>
        <span>${task.content}</span>
      </div>
    `;
  });
  
  taskListDiv.innerHTML = taskHTML;
  messagesContainer.appendChild(taskListDiv);
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// Add inline progress
function addInlineProgress(message) {
  const messagesContainer = document.getElementById('conversationMessages');
  const progressDiv = document.createElement('div');
  progressDiv.style.cssText = 'margin:0.5rem 0 0.5rem 2.5rem;color:#10B981;font-size:0.875rem;font-weight:600;';
  progressDiv.innerHTML = `‚ö° ${message}`;
  messagesContainer.appendChild(progressDiv);
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>

</body>
</html>
